<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="ConnieReads - Your personal book tracker"/>
<meta name="theme-color" content="#1a1612"/>
<title>ConnieReads</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Lora:ital,wght@0,400;0,500;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
<!-- Firebase v10 SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc, writeBatch, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCYgcNE4Np86fBKt5GENBenXhyrsSQYVKQ",
    authDomain: "connie-reads.firebaseapp.com",
    projectId: "connie-reads",
    storageBucket: "connie-reads.firebasestorage.app",
    messagingSenderId: "648707030707",
    appId: "1:648707030707:web:4902dbe402be5a84933ac6",
    measurementId: "G-RJM75LPMG1"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const googleProvider = new GoogleAuthProvider();

  // Expose to global scope for use in non-module scripts
  window._fb = { auth, db, googleProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, signOut, onAuthStateChanged, sendPasswordResetEmail, doc, setDoc, getDoc, collection, getDocs, deleteDoc, writeBatch, onSnapshot, serverTimestamp };

  // Auth state listener
  onAuthStateChanged(auth, user => {
    window._fbUser = user;
    if (window._onAuthReady) window._onAuthReady(user);
  });
</script>

<style>
/* ========== CSS VARIABLES ========== */
:root[data-theme="dark"] {
  --bg-base: #0f0d0b;
  --bg-surface: #1a1612;
  --bg-elevated: #231e18;
  --bg-card: #2a2318;
  --border: #3d3428;
  --border-subtle: #2a2318;
  --text-primary: #f0e8d8;
  --text-secondary: #a89880;
  --text-muted: #6b5d4e;
  --accent: #d4884a;
  --accent-hover: #e09a5e;
  --accent-soft: rgba(212, 136, 74, 0.15);
  --accent-glow: rgba(212, 136, 74, 0.08);
  --green: #6daa7a;
  --green-soft: rgba(109, 170, 122, 0.15);
  --blue: #6a9bbf;
  --blue-soft: rgba(106, 155, 191, 0.15);
  --red: #c0605a;
  --red-soft: rgba(192, 96, 90, 0.15);
  --purple: #9b7fc0;
  --purple-soft: rgba(155, 127, 192, 0.15);
  --star: #e8c55a;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.6);
  --shadow-card: 0 2px 12px rgba(0,0,0,0.3);
  --noise: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
}

:root[data-theme="light"] {
  --bg-base: #f5f0e8;
  --bg-surface: #ede6d8;
  --bg-elevated: #e6dcc8;
  --bg-card: #fff8ee;
  --border: #d4c8b0;
  --border-subtle: #e6dcc8;
  --text-primary: #1a150f;
  --text-secondary: #6b5a42;
  --text-muted: #a08a6e;
  --accent: #c4700a;
  --accent-hover: #d4800a;
  --accent-soft: rgba(196, 112, 10, 0.12);
  --accent-glow: rgba(196, 112, 10, 0.06);
  --green: #2d8a42;
  --green-soft: rgba(45, 138, 66, 0.12);
  --blue: #2a6fa0;
  --blue-soft: rgba(42, 111, 160, 0.12);
  --red: #a83028;
  --red-soft: rgba(168, 48, 40, 0.12);
  --purple: #6b4a9a;
  --purple-soft: rgba(107, 74, 154, 0.12);
  --star: #c49a10;
  --shadow: 0 4px 24px rgba(0,0,0,0.1);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.15);
  --shadow-card: 0 2px 12px rgba(0,0,0,0.08);
}

/* ========== RESET & BASE ========== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg-base);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  transition: background 0.3s, color 0.3s;
}
img { max-width: 100%; }
button { cursor: pointer; border: none; background: none; font-family: inherit; }
input, textarea, select { font-family: inherit; }
a { color: inherit; text-decoration: none; }

/* ========== SCROLLBAR ========== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg-base); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

/* ========== APP LAYOUT ========== */
#app {
  display: flex;
  min-height: 100vh;
}

/* ========== SIDEBAR ========== */
#sidebar {
  width: 240px;
  min-height: 100vh;
  background: var(--bg-surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  padding: 0;
  position: fixed;
  left: 0; top: 0; bottom: 0;
  z-index: 100;
  transition: transform 0.3s ease;
}

.sidebar-logo {
  padding: 24px 20px 20px;
  border-bottom: 1px solid var(--border-subtle);
  display: flex;
  align-items: center;
  gap: 10px;
}
.logo-icon {
  width: 36px;
  height: 36px;
  background: var(--accent);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.logo-text {
  font-family: 'Playfair Display', serif;
  font-size: 20px;
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: -0.3px;
}
.logo-text span { color: var(--accent); }

.sidebar-section-label {
  font-size: 10px;
  font-weight: 500;
  letter-spacing: 1.2px;
  text-transform: uppercase;
  color: var(--text-muted);
  padding: 20px 20px 6px;
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 400;
  cursor: pointer;
  transition: all 0.15s;
  border-left: 2px solid transparent;
  margin: 1px 0;
  border-radius: 0 8px 8px 0;
  margin-right: 12px;
}
.nav-item:hover { color: var(--text-primary); background: var(--bg-elevated); }
.nav-item.active {
  color: var(--accent);
  background: var(--accent-soft);
  border-left-color: var(--accent);
  font-weight: 500;
}
.nav-item svg { width: 16px; height: 16px; flex-shrink: 0; opacity: 0.8; }
.nav-item.active svg { opacity: 1; }

.nav-badge {
  margin-left: auto;
  background: var(--accent-soft);
  color: var(--accent);
  font-size: 11px;
  font-weight: 500;
  padding: 2px 7px;
  border-radius: 20px;
  min-width: 22px;
  text-align: center;
}

.sidebar-footer {
  margin-top: auto;
  border-top: 1px solid var(--border-subtle);
  padding: 12px;
}

.theme-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 10px;
  border-radius: 8px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  font-size: 13px;
  width: 100%;
  transition: all 0.15s;
}
.theme-toggle:hover { color: var(--text-primary); }
.toggle-switch {
  margin-left: auto;
  width: 32px;
  height: 18px;
  background: var(--border);
  border-radius: 9px;
  position: relative;
  transition: background 0.2s;
  flex-shrink: 0;
}
.toggle-switch.on { background: var(--accent); }
.toggle-switch::after {
  content: '';
  position: absolute;
  width: 12px; height: 12px;
  background: white;
  border-radius: 50%;
  top: 3px; left: 3px;
  transition: transform 0.2s;
}
.toggle-switch.on::after { transform: translateX(14px); }

/* ========== MAIN CONTENT ========== */
#main {
  margin-left: 240px;
  flex: 1;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.top-bar {
  background: var(--bg-surface);
  border-bottom: 1px solid var(--border);
  padding: 14px 32px;
  display: flex;
  align-items: center;
  gap: 16px;
  position: sticky;
  top: 0;
  z-index: 50;
}

.top-bar-title {
  font-family: 'Playfair Display', serif;
  font-size: 22px;
  font-weight: 600;
  color: var(--text-primary);
}

.search-bar {
  flex: 1;
  max-width: 400px;
  position: relative;
}
.search-bar input {
  width: 100%;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 9px 14px 9px 38px;
  color: var(--text-primary);
  font-size: 14px;
  transition: border-color 0.15s;
  outline: none;
}
.search-bar input::placeholder { color: var(--text-muted); }
.search-bar input:focus { border-color: var(--accent); }
.search-bar svg {
  position: absolute;
  left: 12px; top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  width: 16px; height: 16px;
  pointer-events: none;
}

.btn {
  display: inline-flex;
  align-items: center;
  gap: 7px;
  padding: 9px 16px;
  border-radius: 9px;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.15s;
  cursor: pointer;
}
.btn-primary {
  background: var(--accent);
  color: white;
  border: none;
}
.btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: var(--shadow); }
.btn-secondary {
  background: var(--bg-elevated);
  color: var(--text-primary);
  border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--bg-card); border-color: var(--accent); }
.btn-ghost {
  color: var(--text-secondary);
  padding: 8px 12px;
}
.btn-ghost:hover { color: var(--text-primary); background: var(--bg-elevated); }
.btn svg { width: 15px; height: 15px; }

.page-content {
  padding: 32px;
  flex: 1;
  max-width: 1400px;
}

/* ========== PAGES ========== */
.page { display: none; animation: fadeIn 0.25s ease; }
.page.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

/* ========== DASHBOARD ========== */
.greeting {
  margin-bottom: 32px;
}
.greeting-sub {
  font-size: 13px;
  color: var(--text-muted);
  letter-spacing: 0.5px;
  margin-bottom: 4px;
  font-family: 'DM Sans', sans-serif;
}
.greeting h1 {
  font-family: 'Playfair Display', serif;
  font-size: 32px;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1.2;
}
.greeting h1 span { color: var(--accent); font-style: italic; }

.stats-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 32px;
}
.stat-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 20px;
  position: relative;
  overflow: hidden;
  transition: transform 0.15s, box-shadow 0.15s;
}
.stat-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
.stat-card::before {
  content: '';
  position: absolute;
  top: 0; right: 0;
  width: 80px; height: 80px;
  border-radius: 50%;
  background: var(--accent-glow);
  transform: translate(30px, -30px);
}
.stat-icon {
  width: 36px; height: 36px;
  border-radius: 9px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 14px;
  font-size: 18px;
}
.stat-value {
  font-family: 'Playfair Display', serif;
  font-size: 32px;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1;
  margin-bottom: 4px;
}
.stat-label {
  font-size: 12px;
  color: var(--text-muted);
  font-weight: 400;
}
.stat-change {
  font-size: 11px;
  margin-top: 6px;
  display: flex;
  align-items: center;
  gap: 3px;
}
.stat-change.up { color: var(--green); }
.stat-change.neutral { color: var(--text-muted); }

.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 24px;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 18px;
}
.section-title {
  font-family: 'Playfair Display', serif;
  font-size: 18px;
  font-weight: 600;
  color: var(--text-primary);
}

/* ========== GOAL CARD ========== */
.goal-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 22px;
  margin-bottom: 24px;
}
.goal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}
.goal-title { font-size: 14px; font-weight: 500; color: var(--text-primary); }
.goal-count {
  font-family: 'Playfair Display', serif;
  font-size: 22px;
  font-weight: 700;
  color: var(--accent);
}
.goal-count span { font-size: 14px; color: var(--text-muted); font-family: 'DM Sans', sans-serif; font-weight: 400; }
.progress-track {
  height: 8px;
  background: var(--bg-elevated);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 8px;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), #e8a060);
  border-radius: 4px;
  transition: width 0.6s ease;
}
.goal-meta { font-size: 12px; color: var(--text-muted); }

/* ========== CURRENTLY READING ========== */
.current-reading {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 22px;
  margin-bottom: 24px;
}
.book-item-horizontal {
  display: flex;
  gap: 14px;
  align-items: flex-start;
  padding: 14px 0;
  border-bottom: 1px solid var(--border-subtle);
}
.book-item-horizontal:last-child { border-bottom: none; padding-bottom: 0; }
.book-cover-sm {
  width: 52px;
  height: 78px;
  border-radius: 4px;
  object-fit: cover;
  background: var(--bg-elevated);
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  box-shadow: 3px 3px 10px rgba(0,0,0,0.3);
  font-size: 22px;
}
.book-cover-sm img { width: 100%; height: 100%; object-fit: cover; }
.book-info-sm { flex: 1; min-width: 0; }
.book-title-sm {
  font-family: 'Lora', serif;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.book-author-sm { font-size: 12px; color: var(--text-muted); margin-bottom: 8px; }
.reading-progress {
  display: flex;
  align-items: center;
  gap: 8px;
}
.reading-progress-bar {
  flex: 1;
  height: 4px;
  background: var(--bg-elevated);
  border-radius: 2px;
  overflow: hidden;
}
.reading-progress-fill {
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
}
.reading-pct { font-size: 11px; color: var(--text-muted); white-space: nowrap; }

/* ========== RECENT ACTIVITY ========== */
.activity-list { display: flex; flex-direction: column; gap: 2px; }
.activity-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 14px;
  border-radius: 10px;
  transition: background 0.12s;
}
.activity-item:hover { background: var(--bg-elevated); }
.activity-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.activity-text { font-size: 13px; color: var(--text-secondary); flex: 1; line-height: 1.4; }
.activity-text strong { color: var(--text-primary); font-weight: 500; }
.activity-time { font-size: 11px; color: var(--text-muted); white-space: nowrap; }

/* ========== SIDEBAR PANELS ========== */
.panel-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 20px;
  margin-bottom: 20px;
}

.collection-pill {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  margin: 3px;
  cursor: pointer;
  transition: all 0.15s;
}
.collection-pill:hover { border-color: var(--accent); color: var(--accent); }
.collection-pill .pill-count {
  background: var(--bg-surface);
  border-radius: 10px;
  padding: 1px 6px;
  font-size: 10px;
}

/* ========== LIBRARY PAGE ========== */
.filter-row {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
  flex-wrap: wrap;
  align-items: center;
}
.filter-chip {
  padding: 7px 14px;
  border-radius: 20px;
  font-size: 13px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
}
.filter-chip:hover, .filter-chip.active {
  background: var(--accent-soft);
  border-color: var(--accent);
  color: var(--accent);
}
.filter-select {
  padding: 7px 28px 7px 12px;
  border-radius: 20px;
  font-size: 13px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  color: var(--text-secondary);
  cursor: pointer;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
}

.view-toggle {
  display: flex;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  margin-left: auto;
}
.view-toggle button {
  padding: 7px 10px;
  color: var(--text-muted);
  transition: all 0.12s;
}
.view-toggle button.active { background: var(--accent); color: white; }

/* ========== BOOK GRID ========== */
.books-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 20px;
}
.books-list { display: flex; flex-direction: column; gap: 10px; }

.book-card {
  cursor: pointer;
  transition: transform 0.15s;
  animation: fadeIn 0.3s ease both;
}
.book-card:hover { transform: translateY(-4px); }
.book-cover-lg {
  width: 100%;
  aspect-ratio: 2/3;
  border-radius: 6px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  margin-bottom: 10px;
  overflow: hidden;
  position: relative;
  box-shadow: 4px 4px 16px rgba(0,0,0,0.35);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36px;
}
.book-cover-lg img { width: 100%; height: 100%; object-fit: cover; }
.book-card-title {
  font-family: 'Lora', serif;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary);
  line-height: 1.3;
  margin-bottom: 3px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.book-card-author { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; }
.book-card-meta {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}
.status-badge {
  font-size: 10px;
  padding: 2px 7px;
  border-radius: 10px;
  font-weight: 500;
}
.status-read { background: var(--green-soft); color: var(--green); }
.status-reading { background: var(--accent-soft); color: var(--accent); }
.status-want { background: var(--blue-soft); color: var(--blue); }
.status-dnf { background: var(--red-soft); color: var(--red); }
.status-borrowed { background: var(--purple-soft); color: var(--purple); }
.stars-small { color: var(--star); font-size: 11px; }
.cover-badge {
  position: absolute;
  top: 8px; right: 8px;
  width: 22px; height: 22px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 600;
}
.cover-badge.owned { background: var(--green); color: white; }
.cover-badge.borrowed { background: var(--purple); color: white; }

/* LIST VIEW */
.book-list-item {
  display: flex;
  gap: 16px;
  align-items: center;
  padding: 14px 18px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.15s;
}
.book-list-item:hover { border-color: var(--accent); transform: translateX(2px); }
.book-list-cover {
  width: 44px; height: 66px;
  border-radius: 4px;
  overflow: hidden;
  flex-shrink: 0;
  background: var(--bg-elevated);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  box-shadow: 2px 2px 8px rgba(0,0,0,0.25);
}
.book-list-cover img { width: 100%; height: 100%; object-fit: cover; }
.book-list-info { flex: 1; min-width: 0; }
.book-list-title {
  font-family: 'Lora', serif;
  font-size: 15px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.book-list-author { font-size: 12px; color: var(--text-muted); margin-bottom: 6px; }
.book-list-badges { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
.book-list-meta {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 6px;
  flex-shrink: 0;
}

/* ========== COLLECTIONS PAGE ========== */
.collections-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 18px;
}
.collection-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.15s;
  position: relative;
  overflow: hidden;
}
.collection-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: var(--shadow); }
.collection-card-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 14px;
}
.collection-emoji { font-size: 28px; margin-bottom: 6px; display: block; }
.collection-name {
  font-family: 'Playfair Display', serif;
  font-size: 17px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 4px;
}
.collection-count { font-size: 12px; color: var(--text-muted); }
.collection-covers {
  display: flex;
  gap: 4px;
  margin-top: 14px;
}
.collection-cover-mini {
  width: 36px; height: 54px;
  border-radius: 3px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  overflow: hidden;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.collection-cover-mini img { width: 100%; height: 100%; object-fit: cover; }
.collection-more {
  width: 36px; height: 54px;
  border-radius: 3px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  color: var(--text-muted);
  font-weight: 500;
}
.add-collection-card {
  border: 2px dashed var(--border);
  background: transparent;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 10px;
  min-height: 160px;
  color: var(--text-muted);
  font-size: 13px;
}
.add-collection-card:hover { border-color: var(--accent); color: var(--accent); }
.add-collection-card svg { width: 28px; height: 28px; }

/* ========== STATS PAGE ========== */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 24px;
}
.stats-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 22px;
}
.stats-card-title {
  font-family: 'Playfair Display', serif;
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 18px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.bar-chart { display: flex; flex-direction: column; gap: 10px; }
.bar-row {
  display: flex;
  align-items: center;
  gap: 10px;
}
.bar-label { font-size: 12px; color: var(--text-secondary); width: 90px; flex-shrink: 0; text-align: right; }
.bar-track {
  flex: 1;
  height: 10px;
  background: var(--bg-elevated);
  border-radius: 5px;
  overflow: hidden;
}
.bar-fill {
  height: 100%;
  border-radius: 5px;
  transition: width 0.8s ease;
}
.bar-value { font-size: 12px; color: var(--text-muted); width: 30px; text-align: right; flex-shrink: 0; }

.year-chart {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  height: 120px;
  padding-top: 10px;
}
.year-bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; height: 100%; }
.year-bar {
  width: 100%;
  border-radius: 4px 4px 0 0;
  transition: height 0.6s ease;
  cursor: pointer;
  position: relative;
}
.year-bar:hover::after {
  content: attr(data-val) ' books';
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  padding: 3px 8px;
  border-radius: 6px;
  font-size: 11px;
  white-space: nowrap;
  color: var(--text-primary);
  margin-bottom: 4px;
}
.year-bar-label { font-size: 10px; color: var(--text-muted); }

.top-list { display: flex; flex-direction: column; gap: 10px; }
.top-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 14px;
  background: var(--bg-elevated);
  border-radius: 10px;
}
.top-rank {
  font-family: 'Playfair Display', serif;
  font-size: 18px;
  font-weight: 700;
  color: var(--text-muted);
  width: 24px;
  text-align: center;
  flex-shrink: 0;
}
.top-rank.gold { color: var(--star); }
.top-rank.silver { color: #aaa; }
.top-rank.bronze { color: #c88c50; }
.top-info { flex: 1; }
.top-name { font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 2px; }
.top-sub { font-size: 12px; color: var(--text-muted); }
.top-val { font-size: 13px; color: var(--accent); font-weight: 500; }

.reading-streak {
  display: flex;
  gap: 3px;
  flex-wrap: wrap;
}
.streak-day {
  width: 12px; height: 12px;
  border-radius: 2px;
  background: var(--bg-elevated);
}
.streak-day.read { background: var(--green); }
.streak-day.partial { background: var(--accent); opacity: 0.5; }

/* ========== SEARCH PAGE ========== */
.search-hero {
  text-align: center;
  padding: 40px 20px 32px;
}
.search-hero h2 {
  font-family: 'Playfair Display', serif;
  font-size: 28px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
}
.search-hero p { color: var(--text-muted); font-size: 14px; margin-bottom: 24px; }
.search-hero-bar {
  max-width: 500px;
  margin: 0 auto;
  position: relative;
}
.search-hero-bar input {
  width: 100%;
  background: var(--bg-card);
  border: 2px solid var(--border);
  border-radius: 14px;
  padding: 14px 18px 14px 46px;
  font-size: 15px;
  color: var(--text-primary);
  outline: none;
  transition: border-color 0.2s;
}
.search-hero-bar input:focus { border-color: var(--accent); }
.search-hero-bar svg {
  position: absolute;
  left: 15px; top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  width: 18px; height: 18px;
  pointer-events: none;
}
.search-results {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 20px;
  margin-top: 32px;
}
.search-result-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  transition: all 0.15s;
  animation: fadeIn 0.3s ease both;
}
.search-result-card:hover { border-color: var(--accent); transform: translateY(-2px); }
.search-cover {
  width: 100%;
  aspect-ratio: 2/3;
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 12px;
  background: var(--bg-elevated);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36px;
  box-shadow: 3px 3px 12px rgba(0,0,0,0.3);
}
.search-cover img { width: 100%; height: 100%; object-fit: cover; }
.search-book-title {
  font-family: 'Lora', serif;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary);
  margin-bottom: 4px;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.search-book-author { font-size: 11px; color: var(--text-muted); margin-bottom: 10px; }
.search-add-btn {
  width: 100%;
  padding: 7px;
  border-radius: 7px;
  background: var(--accent-soft);
  color: var(--accent);
  font-size: 12px;
  font-weight: 500;
  border: 1px solid transparent;
  transition: all 0.15s;
}
.search-add-btn:hover { background: var(--accent); color: white; }
.search-add-btn.added { background: var(--green-soft); color: var(--green); }

/* ========== MODAL ========== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  animation: fadeIn 0.2s ease;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 18px;
  width: 100%;
  max-width: 680px;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.25s ease;
}
@keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 22px 26px 18px;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  background: var(--bg-surface);
  z-index: 1;
}
.modal-title {
  font-family: 'Playfair Display', serif;
  font-size: 20px;
  font-weight: 600;
  color: var(--text-primary);
}
.modal-close {
  width: 32px; height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
  transition: all 0.12s;
}
.modal-close:hover { background: var(--bg-elevated); color: var(--text-primary); }
.modal-body { padding: 24px 26px; }

.modal-book-hero {
  display: flex;
  gap: 22px;
  margin-bottom: 24px;
}
.modal-cover {
  width: 100px; height: 150px;
  border-radius: 6px;
  overflow: hidden;
  flex-shrink: 0;
  background: var(--bg-elevated);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  box-shadow: 4px 4px 16px rgba(0,0,0,0.35);
  position: relative;
}
.modal-cover img { width: 100%; height: 100%; object-fit: cover; }
.modal-book-info { flex: 1; }
.modal-book-title {
  font-family: 'Playfair Display', serif;
  font-size: 22px;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1.2;
  margin-bottom: 6px;
}
.modal-book-author {
  font-family: 'Lora', serif;
  font-size: 14px;
  font-style: italic;
  color: var(--text-secondary);
  margin-bottom: 12px;
}
.modal-book-desc {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.6;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.cover-actions {
  display: flex;
  gap: 6px;
  margin-top: 8px;
  flex-wrap: wrap;
}
.cover-action-btn {
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 6px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.12s;
}
.cover-action-btn:hover { border-color: var(--accent); color: var(--accent); }

/* FORM FIELDS */
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
.form-group { margin-bottom: 16px; }
.form-group.full { grid-column: 1/-1; }
.form-label {
  display: block;
  font-size: 12px;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 6px;
  letter-spacing: 0.3px;
  text-transform: uppercase;
}
.form-input {
  width: 100%;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 9px;
  padding: 10px 14px;
  color: var(--text-primary);
  font-size: 14px;
  outline: none;
  transition: border-color 0.15s;
}
.form-input:focus { border-color: var(--accent); }
.form-select {
  width: 100%;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 9px;
  padding: 10px 14px;
  color: var(--text-primary);
  font-size: 14px;
  outline: none;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
}
.form-textarea {
  width: 100%;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 9px;
  padding: 10px 14px;
  color: var(--text-primary);
  font-size: 14px;
  outline: none;
  resize: vertical;
  min-height: 90px;
  line-height: 1.5;
  transition: border-color 0.15s;
}
.form-textarea:focus { border-color: var(--accent); }

.star-rating { display: flex; gap: 4px; }
.star-btn {
  font-size: 22px;
  color: var(--border);
  cursor: pointer;
  transition: all 0.1s;
  padding: 2px;
}
.star-btn:hover, .star-btn.active { color: var(--star); transform: scale(1.1); }

.checkbox-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
.checkbox-item {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 8px 14px;
  border-radius: 9px;
  border: 1px solid var(--border);
  background: var(--bg-elevated);
  cursor: pointer;
  font-size: 13px;
  color: var(--text-secondary);
  transition: all 0.12s;
  user-select: none;
}
.checkbox-item.checked {
  border-color: var(--accent);
  background: var(--accent-soft);
  color: var(--accent);
}
.checkbox-item input { display: none; }

.cover-url-group {
  display: flex;
  gap: 8px;
}
.cover-url-group input { flex: 1; }
.cover-url-group button { flex-shrink: 0; }

.modal-footer {
  padding: 16px 26px 22px;
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  border-top: 1px solid var(--border);
}

/* ========== SETTINGS PAGE ========== */
.settings-grid {
  display: grid;
  grid-template-columns: 220px 1fr;
  gap: 24px;
  align-items: start;
}
.settings-nav {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
}
.settings-nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 13px 18px;
  font-size: 14px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.12s;
  border-left: 3px solid transparent;
}
.settings-nav-item:hover { background: var(--bg-elevated); color: var(--text-primary); }
.settings-nav-item.active { background: var(--accent-soft); color: var(--accent); border-left-color: var(--accent); }
.settings-nav-item svg { width: 15px; height: 15px; }

.settings-panel { display: none; }
.settings-panel.active { display: block; }
.settings-section {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 24px;
  margin-bottom: 20px;
}
.settings-section h3 {
  font-family: 'Playfair Display', serif;
  font-size: 17px;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 20px;
}
.setting-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid var(--border-subtle);
}
.setting-row:last-child { border-bottom: none; }
.setting-info { flex: 1; }
.setting-name { font-size: 14px; color: var(--text-primary); margin-bottom: 2px; }
.setting-desc { font-size: 12px; color: var(--text-muted); }
.big-toggle {
  width: 44px; height: 24px;
  background: var(--border);
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: background 0.2s;
  flex-shrink: 0;
}
.big-toggle.on { background: var(--accent); }
.big-toggle::after {
  content: '';
  position: absolute;
  width: 18px; height: 18px;
  background: white;
  border-radius: 50%;
  top: 3px; left: 3px;
  transition: transform 0.2s;
}
.big-toggle.on::after { transform: translateX(20px); }

.import-drop-zone {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 32px;
  text-align: center;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s;
  margin-top: 16px;
}
.import-drop-zone:hover { border-color: var(--accent); color: var(--accent); }
.import-drop-zone svg { width: 32px; height: 32px; margin-bottom: 12px; }
.import-drop-zone p { font-size: 14px; margin-bottom: 4px; }
.import-drop-zone span { font-size: 12px; }

/* ========== READING GOAL SETUP ========== */
.goal-setup {
  display: flex;
  align-items: center;
  gap: 14px;
  margin-top: 16px;
}
.goal-setup input {
  width: 80px;
  text-align: center;
  font-family: 'Playfair Display', serif;
  font-size: 24px;
  font-weight: 700;
}

/* ========== TOAST ========== */
.toast-container {
  position: fixed;
  bottom: 24px; right: 24px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.toast {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 18px;
  font-size: 13px;
  color: var(--text-primary);
  box-shadow: var(--shadow);
  animation: slideUp 0.25s ease;
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 240px;
}
.toast.success { border-left: 3px solid var(--green); }
.toast.error { border-left: 3px solid var(--red); }
.toast.info { border-left: 3px solid var(--blue); }
.toast-icon { font-size: 16px; }
.toast-fade-out { animation: fadeOut 0.3s ease forwards; }
@keyframes fadeOut { to { opacity: 0; transform: translateX(20px); } }

/* ========== EMPTY STATE ========== */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text-muted);
}
.empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.4; }
.empty-state h3 {
  font-family: 'Playfair Display', serif;
  font-size: 20px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.empty-state p { font-size: 14px; line-height: 1.5; }

/* ========== MOBILE NAV ========== */
#mobile-nav {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  background: var(--bg-surface);
  border-top: 1px solid var(--border);
  z-index: 100;
  padding: 8px 0 env(safe-area-inset-bottom);
}
.mobile-nav-grid { display: flex; justify-content: space-around; }
.mobile-nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  padding: 6px 12px;
  color: var(--text-muted);
  font-size: 10px;
  cursor: pointer;
  transition: color 0.12s;
  border-radius: 8px;
}
.mobile-nav-item.active { color: var(--accent); }
.mobile-nav-item svg { width: 22px; height: 22px; }

/* ========== HAMBURGER ========== */
#sidebar-toggle {
  display: none;
  width: 36px; height: 36px;
  border-radius: 8px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  cursor: pointer;
}

.sidebar-backdrop {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 99;
}

/* ========== RESPONSIVE ========== */
@media (max-width: 900px) {
  #sidebar { transform: translateX(-100%); }
  #sidebar.open { transform: translateX(0); }
  .sidebar-backdrop.open { display: block; }
  #sidebar-toggle { display: flex; }
  #main { margin-left: 0; }
  #mobile-nav { display: block; }
  .page-content { padding: 20px 16px 90px; }
  .stats-row { grid-template-columns: 1fr 1fr; }
  .dashboard-grid { grid-template-columns: 1fr; }
  .stats-grid { grid-template-columns: 1fr; }
  .settings-grid { grid-template-columns: 1fr; }
  .books-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
  .form-row { grid-template-columns: 1fr; }
}
@media (max-width: 480px) {
  .stats-row { grid-template-columns: 1fr 1fr; gap: 10px; }
  .stat-value { font-size: 24px; }
  .top-bar-title { font-size: 18px; }
  .books-grid { grid-template-columns: repeat(3, 1fr); gap: 12px; }
}

/* ========== AUTH SCREEN ========== */
#auth-screen {
  position: fixed;
  inset: 0;
  background: var(--bg-base);
  z-index: 9000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}
#auth-screen.hidden { display: none; }

.auth-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 24px;
  padding: 40px 36px;
  width: 100%;
  max-width: 400px;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.35s ease;
}
.auth-logo {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  margin-bottom: 32px;
}
.auth-logo-icon {
  width: 56px; height: 56px;
  background: var(--accent);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8px 24px rgba(212,136,74,0.4);
}
.auth-logo-name {
  font-family: 'Playfair Display', serif;
  font-size: 28px;
  font-weight: 700;
  color: var(--text-primary);
  letter-spacing: -0.5px;
}
.auth-logo-name span { color: var(--accent); font-style: italic; }
.auth-logo-sub { font-size: 13px; color: var(--text-muted); }

.auth-tabs {
  display: flex;
  background: var(--bg-elevated);
  border-radius: 10px;
  padding: 3px;
  margin-bottom: 24px;
}
.auth-tab {
  flex: 1;
  padding: 8px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-muted);
  text-align: center;
  cursor: pointer;
  transition: all 0.15s;
}
.auth-tab.active {
  background: var(--bg-card);
  color: var(--text-primary);
  box-shadow: var(--shadow-card);
}

.auth-form { display: none; }
.auth-form.active { display: block; }

.auth-divider {
  display: flex;
  align-items: center;
  gap: 12px;
  margin: 18px 0;
  color: var(--text-muted);
  font-size: 12px;
}
.auth-divider::before, .auth-divider::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

.btn-google {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 11px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--bg-elevated);
  color: var(--text-primary);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s;
  margin-bottom: 6px;
}
.btn-google:hover { border-color: var(--accent); background: var(--accent-soft); }
.btn-google svg { width: 18px; height: 18px; flex-shrink: 0; }

.auth-error {
  background: var(--red-soft);
  border: 1px solid var(--red);
  color: var(--red);
  border-radius: 8px;
  padding: 10px 14px;
  font-size: 13px;
  margin-top: 12px;
  display: none;
}
.auth-error.show { display: block; }
.auth-loading {
  display: none;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 20px;
  color: var(--text-muted);
  font-size: 13px;
}
.auth-loading.show { display: flex; }
.spin {
  width: 18px; height: 18px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ========== SYNC INDICATOR ========== */
.sync-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--green);
  margin-left: auto;
  transition: background 0.3s;
  flex-shrink: 0;
}
.sync-dot.syncing {
  background: var(--accent);
  animation: pulse 1s ease infinite;
}
.sync-dot.error { background: var(--red); }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

/* ========== USER PROFILE AREA ========== */
.user-profile {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  border-radius: 10px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.15s;
  margin: 8px 12px 0;
}
.user-profile:hover { border-color: var(--accent); }
.user-avatar {
  width: 30px; height: 30px;
  border-radius: 50%;
  background: var(--accent);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 600;
  color: white;
  flex-shrink: 0;
  overflow: hidden;
}
.user-avatar img { width: 100%; height: 100%; object-fit: cover; }
.user-name { font-size: 13px; font-weight: 500; color: var(--text-primary); flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.signout-btn {
  font-size: 11px;
  color: var(--text-muted);
  padding: 3px 7px;
  border-radius: 5px;
  border: 1px solid var(--border);
  background: none;
  cursor: pointer;
  transition: all 0.12s;
  flex-shrink: 0;
}
.signout-btn:hover { color: var(--red); border-color: var(--red); }

/* ========== BOOK SPINE PLACEHOLDER ========== */
.book-spine {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 8px 6px;
  position: relative;
  overflow: hidden;
}
.book-spine::before {
  content: '';
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 6px;
  background: rgba(0,0,0,0.25);
}
.book-spine::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, transparent 50%, rgba(0,0,0,0.15) 100%);
}
.book-spine-title {
  font-family: 'Lora', serif;
  font-size: 10px;
  font-weight: 600;
  color: rgba(255,255,255,0.95);
  text-align: center;
  line-height: 1.3;
  word-break: break-word;
  z-index: 1;
  text-shadow: 0 1px 3px rgba(0,0,0,0.4);
  display: -webkit-box;
  -webkit-line-clamp: 4;
  -webkit-box-orient: vertical;
  overflow: hidden;
  margin-bottom: 4px;
}
.book-spine-author {
  font-size: 8px;
  color: rgba(255,255,255,0.7);
  text-align: center;
  z-index: 1;
  text-shadow: 0 1px 2px rgba(0,0,0,0.4);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* ========== LEADERBOARD STATS ========== */
.leaderboard-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 14px;
  border-radius: 10px;
  background: var(--bg-elevated);
  margin-bottom: 6px;
  transition: background 0.12s;
}
.leaderboard-item:hover { background: var(--bg-card); }
.leaderboard-rank {
  font-family: 'Playfair Display', serif;
  font-size: 20px;
  font-weight: 700;
  width: 28px;
  text-align: center;
  flex-shrink: 0;
}
.lb-medal-1 { color: #f5c842; }
.lb-medal-2 { color: #b0b8c1; }
.lb-medal-3 { color: #cd7f32; }
.lb-medal-n { color: var(--text-muted); font-size: 15px; }
.leaderboard-cover {
  width: 36px; height: 54px;
  border-radius: 3px;
  overflow: hidden;
  flex-shrink: 0;
  background: var(--bg-surface);
  flex-shrink: 0;
}
.leaderboard-cover img { width: 100%; height: 100%; object-fit: cover; }
.leaderboard-info { flex: 1; min-width: 0; }
.leaderboard-title {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 2px;
}
.leaderboard-sub { font-size: 11px; color: var(--text-muted); }
.leaderboard-score {
  font-family: 'Playfair Display', serif;
  font-size: 16px;
  font-weight: 700;
  color: var(--star);
  flex-shrink: 0;
}
.stats-full-width { grid-column: 1 / -1; }
.reading-time-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}
.time-stat-box {
  background: var(--bg-elevated);
  border-radius: 10px;
  padding: 14px;
  text-align: center;
}
.time-stat-val {
  font-family: 'Playfair Display', serif;
  font-size: 24px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 4px;
}
.time-stat-label { font-size: 11px; color: var(--text-muted); }
</style>
</head>
<body>

<!-- ===== AUTH SCREEN ===== -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo">
      <div class="auth-logo-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" width="28" height="28">
          <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
          <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
          <path d="M9 7h7M9 10h5" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="auth-logo-name">Connie<span>Reads</span></div>
      <div class="auth-logo-sub">Your personal reading library</div>
    </div>

    <div class="auth-loading show" id="auth-loading">
      <div class="spin"></div> Loading...
    </div>

    <div id="auth-forms" style="display:none;">
      <div class="auth-tabs">
        <div class="auth-tab active" onclick="switchAuthTab('signin')">Sign In</div>
        <div class="auth-tab" onclick="switchAuthTab('signup')">Create Account</div>
      </div>

      <!-- Sign In -->
      <div class="auth-form active" id="auth-signin">
        <button class="btn-google" onclick="authWithGoogle()">
          <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
          Continue with Google
        </button>
        <div class="auth-divider">or sign in with email</div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="signin-email" placeholder="you@example.com" autocomplete="email"/>
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="signin-password" placeholder="••••••••" autocomplete="current-password" onkeydown="if(event.key==='Enter')authSignIn()"/>
        </div>
        <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:4px;" onclick="authSignIn()">Sign In</button>
        <div style="text-align:center;margin-top:12px;">
          <button style="font-size:12px;color:var(--text-muted);background:none;border:none;cursor:pointer;text-decoration:underline;" onclick="authForgotPassword()">Forgot password?</button>
        </div>
        <div class="auth-error" id="signin-error"></div>
      </div>

      <!-- Sign Up -->
      <div class="auth-form" id="auth-signup">
        <button class="btn-google" onclick="authWithGoogle()">
          <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
          Sign up with Google
        </button>
        <div class="auth-divider">or create account</div>
        <div class="form-group">
          <label class="form-label">Display Name</label>
          <input type="text" class="form-input" id="signup-name" placeholder="Connie"/>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="signup-email" placeholder="you@example.com" autocomplete="email"/>
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input type="password" class="form-input" id="signup-password" placeholder="At least 6 characters" autocomplete="new-password" onkeydown="if(event.key==='Enter')authSignUp()"/>
        </div>
        <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:4px;" onclick="authSignUp()">Create Account</button>
        <div class="auth-error" id="signup-error"></div>
      </div>
    </div>
  </div>
</div>

<div id="app">
  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="sidebar-logo">
      <div class="logo-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" width="20" height="20">
          <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
          <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
          <path d="M9 7h7M9 10h5" stroke-linecap="round"/>
        </svg>
      </div>
      <span class="logo-text">Connie<span>Reads</span></span>
    </div>

    <div class="sidebar-section-label">Navigation</div>
    <nav>
      <div class="nav-item active" onclick="showPage('dashboard')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        Dashboard
      </div>
      <div class="nav-item" onclick="showPage('search')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35" stroke-linecap="round"/></svg>
        Discover
      </div>
      <div class="nav-item" onclick="showPage('library')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
        My Library
        <span class="nav-badge" id="lib-count">0</span>
      </div>
      <div class="nav-item" onclick="showPage('collections')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
        Collections
      </div>
    </nav>

    <div class="sidebar-section-label">Insights</div>
    <nav>
      <div class="nav-item" onclick="showPage('stats')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        Statistics
      </div>
      <div class="nav-item" onclick="showPage('settings')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        Settings
      </div>
    </nav>

    <div class="sidebar-footer">
      <div id="user-profile-area" class="user-profile" style="margin-bottom:10px;">
        <div class="user-avatar" id="user-avatar">?</div>
        <div class="user-name" id="user-display-name">Loading...</div>
        <div class="sync-dot" id="sync-dot" title="Synced to cloud"></div>
      </div>
      <button class="btn btn-ghost" style="width:100%; justify-content:center; font-size:12px; color:var(--red); padding:7px;" onclick="authSignOut()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="13" height="13"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Sign Out
      </button>
      <button class="theme-toggle" onclick="toggleTheme()" style="margin-top:8px;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        Light Mode
        <div class="toggle-switch" id="theme-switch"></div>
      </button>
    </div>
  </aside>

  <div class="sidebar-backdrop" id="sidebar-backdrop" onclick="closeSidebar()"></div>

  <!-- MAIN -->
  <main id="main">
    <div class="top-bar">
      <button id="sidebar-toggle" onclick="toggleSidebar()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <span class="top-bar-title" id="page-title">Dashboard</span>
      <div class="search-bar" style="display:none" id="top-search-wrap">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35" stroke-linecap="round"/></svg>
        <input type="text" placeholder="Filter library..." id="lib-filter-input" oninput="filterLibrary()" />
      </div>
      <div style="margin-left:auto; display:flex; gap:8px;" id="top-actions">
        <button class="btn btn-primary" onclick="openAddModal()" id="add-book-btn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Book
        </button>
      </div>
    </div>

    <div class="page-content">

      <!-- ===== DASHBOARD PAGE ===== -->
      <div class="page active" id="page-dashboard">
        <div class="greeting">
          <div class="greeting-sub">📖 Good reading,</div>
          <h1>Welcome to your <span>library</span></h1>
        </div>

        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-icon" style="background:var(--accent-soft);">📚</div>
            <div class="stat-value" id="stat-total">0</div>
            <div class="stat-label">Books in Library</div>
            <div class="stat-change neutral">Total collection</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background:var(--green-soft);">✅</div>
            <div class="stat-value" id="stat-read">0</div>
            <div class="stat-label">Books Read</div>
            <div class="stat-change up" id="stat-read-year">this year</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background:var(--blue-soft);">📖</div>
            <div class="stat-value" id="stat-reading">0</div>
            <div class="stat-label">Currently Reading</div>
            <div class="stat-change neutral">in progress</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background:var(--purple-soft);">🎯</div>
            <div class="stat-value" id="stat-goal-pct">0%</div>
            <div class="stat-label">Goal Progress</div>
            <div class="stat-change neutral" id="stat-goal-detail">set a goal</div>
          </div>
        </div>

        <div class="dashboard-grid">
          <div>
            <!-- Goal Progress -->
            <div class="goal-card" id="dash-goal-card">
              <div class="goal-header">
                <div>
                  <div style="font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px;">Reading Goal <span id="goal-year"></span></div>
                  <div class="goal-title" id="goal-title-text">Set your reading goal</div>
                </div>
                <div class="goal-count" id="goal-count-text">0 <span>/ 0</span></div>
              </div>
              <div class="progress-track">
                <div class="progress-fill" id="goal-progress-fill" style="width:0%"></div>
              </div>
              <div class="goal-meta" id="goal-meta-text">Set a goal in Settings to track your progress</div>
            </div>

            <!-- Currently Reading -->
            <div class="current-reading">
              <div class="section-header">
                <div class="section-title">Currently Reading</div>
                <button class="btn btn-ghost" style="font-size:12px;" onclick="showPage('library')">View all →</button>
              </div>
              <div id="currently-reading-list">
                <div class="empty-state" style="padding:30px 20px;">
                  <p style="font-size:13px;">No books in progress. Start reading!</p>
                </div>
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="panel-card">
              <div class="section-header">
                <div class="section-title">Recent Activity</div>
              </div>
              <div class="activity-list" id="activity-list">
                <div style="text-align:center; padding:20px; color:var(--text-muted); font-size:13px;">No activity yet. Add some books!</div>
              </div>
            </div>
          </div>

          <div>
            <!-- Quick Collections -->
            <div class="panel-card">
              <div class="section-header">
                <div class="section-title">Collections</div>
                <button class="btn btn-ghost" style="font-size:12px;" onclick="showPage('collections')">Manage →</button>
              </div>
              <div id="dash-collections">
                <div style="font-size:13px; color:var(--text-muted);">No collections yet</div>
              </div>
            </div>

            <!-- Want to Read -->
            <div class="panel-card">
              <div class="section-header">
                <div class="section-title">Want to Read</div>
                <span style="font-size:12px; color:var(--text-muted);" id="want-count">0 books</span>
              </div>
              <div id="want-to-read-list">
                <div style="font-size:13px; color:var(--text-muted);">Your wish list is empty</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ===== SEARCH / DISCOVER PAGE ===== -->
      <div class="page" id="page-search">
        <div class="search-hero">
          <h2>Discover Your Next Read</h2>
          <p>Search millions of books and add them to your library</p>
          <div class="search-hero-bar">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35" stroke-linecap="round"/></svg>
            <input type="text" id="discover-search" placeholder="Search by title, author, ISBN..." onkeydown="if(event.key==='Enter') searchBooks()" />
          </div>
          <div style="display:flex; gap:8px; justify-content:center; margin-top:12px; flex-wrap:wrap;">
            <button class="filter-chip" onclick="searchBooks('fantasy')">Fantasy</button>
            <button class="filter-chip" onclick="searchBooks('horror')">Horror</button>
            <button class="filter-chip" onclick="searchBooks('romance')">Romance</button>
            <button class="filter-chip" onclick="searchBooks('science fiction')">Sci-Fi</button>
            <button class="filter-chip" onclick="searchBooks('lgbtq')">LGBTQ+</button>
            <button class="filter-chip" onclick="searchBooks('thriller')">Thriller</button>
          </div>
        </div>
        <div id="search-results-grid" class="search-results"></div>
      </div>

      <!-- ===== LIBRARY PAGE ===== -->
      <div class="page" id="page-library">
        <div class="filter-row">
          <div id="top-search-wrap-lib" style="position:relative; flex:1; max-width:280px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position:absolute;left:10px;top:50%;transform:translateY(-50%);width:14px;height:14px;color:var(--text-muted);pointer-events:none;"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35" stroke-linecap="round"/></svg>
            <input type="text" class="form-input" style="padding-left:32px;border-radius:20px;" placeholder="Filter books..." id="lib-filter" oninput="filterLibrary()"/>
          </div>
          <button class="filter-chip active" id="filter-all" onclick="setStatusFilter('all',this)">All</button>
          <button class="filter-chip" id="filter-reading" onclick="setStatusFilter('reading',this)">Reading</button>
          <button class="filter-chip" id="filter-read" onclick="setStatusFilter('read',this)">Read</button>
          <button class="filter-chip" id="filter-want" onclick="setStatusFilter('want',this)">Want to Read</button>
          <button class="filter-chip" id="filter-dnf" onclick="setStatusFilter('dnf',this)">DNF</button>
          <select class="filter-select" onchange="setSortBy(this.value)" style="margin-left:8px;">
            <option value="dateAdded">Date Added</option>
            <option value="title">Title A-Z</option>
            <option value="author">Author</option>
            <option value="rating">Rating</option>
            <option value="dateRead">Date Read</option>
          </select>
          <div class="view-toggle">
            <button id="grid-view-btn" class="active" onclick="setView('grid')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            </button>
            <button id="list-view-btn" onclick="setView('list')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
            </button>
          </div>
        </div>
        <div id="library-grid" class="books-grid"></div>
        <div id="library-empty" class="empty-state" style="display:none;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
          <h3>Your library is empty</h3>
          <p>Search for books in Discover or use the + Add Book button to get started.</p>
        </div>
      </div>

      <!-- ===== COLLECTIONS PAGE ===== -->
      <div class="page" id="page-collections">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:28px;">
          <div>
            <h2 style="font-family:'Playfair Display',serif; font-size:26px; font-weight:700; color:var(--text-primary);">Collections</h2>
            <p style="font-size:13px; color:var(--text-muted); margin-top:4px;">Organise your books into custom lists</p>
          </div>
          <button class="btn btn-primary" onclick="openNewCollectionModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="14" height="14"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            New Collection
          </button>
        </div>
        <div class="collections-grid" id="collections-grid"></div>
      </div>

      <!-- ===== STATS PAGE ===== -->
      <div class="page" id="page-stats">
        <div class="greeting" style="margin-bottom:28px;">
          <h1 style="font-size:26px;">Reading <span>Statistics</span></h1>
        </div>
        <div class="stats-row" style="margin-bottom:28px;">
          <div class="stat-card"><div class="stat-icon" style="background:var(--accent-soft);">📚</div><div class="stat-value" id="s-total">0</div><div class="stat-label">Total Books</div></div>
          <div class="stat-card"><div class="stat-icon" style="background:var(--green-soft);">✅</div><div class="stat-value" id="s-read">0</div><div class="stat-label">Books Read</div></div>
          <div class="stat-card"><div class="stat-icon" style="background:var(--star);">⭐</div><div class="stat-value" id="s-avg-rating">—</div><div class="stat-label">Avg Rating</div></div>
          <div class="stat-card"><div class="stat-icon" style="background:var(--purple-soft);">🎭</div><div class="stat-value" id="s-genres">0</div><div class="stat-label">Genres Read</div></div>
        </div>

        <div class="stats-grid">
          <div class="stats-card">
            <div class="stats-card-title">📅 Books Read Per Year</div>
            <div class="year-chart" id="year-chart"></div>
          </div>
          <div class="stats-card">
            <div class="stats-card-title">🎭 Genres</div>
            <div class="bar-chart" id="genre-chart"></div>
          </div>
          <div class="stats-card">
            <div class="stats-card-title">🏆 Top Authors</div>
            <div class="top-list" id="authors-list"></div>
          </div>
          <div class="stats-card">
            <div class="stats-card-title">⭐ Rating Distribution</div>
            <div class="bar-chart" id="rating-chart"></div>
          </div>
          <div class="stats-card stats-full-width">
            <div class="stats-card-title">🥇 Best Rated Books</div>
            <div id="best-rated-list"></div>
          </div>
          <div class="stats-card">
            <div class="stats-card-title">📖 Most Read Authors</div>
            <div id="most-read-authors-list"></div>
          </div>
          <div class="stats-card">
            <div class="stats-card-title">📊 Reading Summary</div>
            <div class="reading-time-stats" id="reading-summary"></div>
          </div>
          <div class="stats-card">
            <div class="stats-card-title">📚 Format Breakdown</div>
            <div class="bar-chart" id="format-chart"></div>
          </div>
          <div class="stats-card">
            <div class="stats-card-title">🗓️ Monthly Reading</div>
            <div class="year-chart" id="monthly-chart" style="height:100px;"></div>
          </div>
        </div>
      </div>

      <!-- ===== SETTINGS PAGE ===== -->
      <div class="page" id="page-settings">
        <div class="greeting" style="margin-bottom:28px;">
          <h1 style="font-size:26px;">Settings</h1>
        </div>
        <div class="settings-grid">
          <div class="settings-nav">
            <div class="settings-nav-item active" onclick="showSettingsPanel('appearance', this)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 0 1 0 20"/><path d="M12 8a4 4 0 0 1 0 8"/></svg>
              Appearance
            </div>
            <div class="settings-nav-item" onclick="showSettingsPanel('profile', this)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              Profile
            </div>
            <div class="settings-nav-item" onclick="showSettingsPanel('goals', this)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
              Reading Goals
            </div>
            <div class="settings-nav-item" onclick="showSettingsPanel('data', this)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><polyline points="8 17 12 21 16 17"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29"/></svg>
              Import / Export
            </div>
            <div class="settings-nav-item" onclick="showSettingsPanel('about', this)">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="15" height="15"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
              About
            </div>
          </div>

          <div>
            <!-- APPEARANCE -->
            <div class="settings-panel active" id="sp-appearance">
              <div class="settings-section">
                <h3>Appearance</h3>
                <div class="setting-row">
                  <div class="setting-info">
                    <div class="setting-name">Dark Mode</div>
                    <div class="setting-desc">Switch between light and dark theme</div>
                  </div>
                  <div class="big-toggle on" id="theme-toggle-settings" onclick="toggleTheme()"></div>
                </div>
              </div>
            </div>

            <!-- PROFILE -->
            <div class="settings-panel" id="sp-profile">
              <div class="settings-section">
                <h3>Profile</h3>
                <div class="form-group">
                  <label class="form-label">Display Name</label>
                  <div style="display:flex; gap:10px;">
                    <input type="text" class="form-input" id="profile-display-name" placeholder="Your name"/>
                    <button class="btn btn-primary" onclick="saveDisplayName()">Save</button>
                  </div>
                  <div style="font-size:12px; color:var(--text-muted); margin-top:6px;">This name appears in the sidebar and dashboard greeting.</div>
                </div>
                <div class="form-group" style="margin-top:16px;">
                  <label class="form-label">Email</label>
                  <div style="font-size:14px; color:var(--text-secondary); padding: 10px 14px; background:var(--bg-elevated); border-radius:9px; border:1px solid var(--border);" id="profile-email">—</div>
                </div>
              </div>
            </div>

            <!-- GOALS -->
            <div class="settings-panel" id="sp-goals">
              <div class="settings-section">
                <h3>Reading Goals</h3>
                <div class="setting-row">
                  <div class="setting-info">
                    <div class="setting-name">Yearly Reading Goal</div>
                    <div class="setting-desc">How many books do you want to read this year?</div>
                  </div>
                </div>
                <div class="goal-setup">
                  <input type="number" class="form-input" id="goal-input" placeholder="52" min="1" max="999" style="width:90px; text-align:center; font-size:22px; font-family:'Playfair Display',serif; font-weight:700;"/>
                  <span style="font-size:14px; color:var(--text-muted);">books in <strong id="goal-year-setting"></strong></span>
                  <button class="btn btn-primary" onclick="saveGoal()">Save Goal</button>
                </div>
              </div>
            </div>

            <!-- DATA -->
            <div class="settings-panel" id="sp-data">
              <div class="settings-section">
                <h3>Import Data</h3>
                <p style="font-size:13px; color:var(--text-muted); margin-bottom:16px;">Import your reading history from Goodreads (CSV export) or a ConnieReads backup.</p>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <label class="btn btn-secondary" style="cursor:pointer;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Import Goodreads CSV
                    <input type="file" accept=".csv" style="display:none;" onchange="importGoodreads(event)"/>
                  </label>
                  <label class="btn btn-secondary" style="cursor:pointer;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Import ConnieReads JSON
                    <input type="file" accept=".json" style="display:none;" onchange="importShelfwise(event)"/>
                  </label>
                </div>
              </div>
              <div class="settings-section">
                <h3>Export Data</h3>
                <p style="font-size:13px; color:var(--text-muted); margin-bottom:16px;">Download a backup of your entire ConnieReads library.</p>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn btn-secondary" onclick="exportData('json')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Export as JSON
                  </button>
                  <button class="btn btn-secondary" onclick="exportData('csv')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Export as CSV
                  </button>
                </div>
              </div>
              <div class="settings-section" style="border: 1px solid var(--red-soft);">
                <h3 style="color:var(--red);">Danger Zone</h3>
                <p style="font-size:13px; color:var(--text-muted); margin-bottom:16px;">This will permanently delete all your books, collections, and settings.</p>
                <button class="btn" style="background:var(--red-soft); color:var(--red); border:1px solid var(--red);" onclick="clearAllData()">Clear All Data</button>
              </div>
            </div>

            <!-- ABOUT -->
            <div class="settings-panel" id="sp-about">
              <div class="settings-section" style="text-align:center;">
                <div style="margin-bottom:20px;">
                  <div style="width:64px; height:64px; background:var(--accent); border-radius:14px; display:flex; align-items:center; justify-content:center; margin:0 auto 16px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" width="32" height="32"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/><path d="M9 7h7M9 10h5" stroke-linecap="round"/></svg>
                  </div>
                  <div style="font-family:'Playfair Display',serif; font-size:28px; font-weight:700; color:var(--text-primary);">ConnieReads</div>
                  <div style="font-size:13px; color:var(--text-muted); margin-top:4px;">Version 1.1.0</div>
                </div>
                <p style="font-size:14px; color:var(--text-secondary); max-width:400px; margin:0 auto 20px; line-height:1.6;">Your personal book tracker. Track your reading, discover new books, and organise your library your way.</p>
                <div style="font-size:12px; color:var(--text-muted);">Built with ❤️ for Connie</div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /page-content -->
  </main>
</div>

<!-- MOBILE BOTTOM NAV -->
<nav id="mobile-nav">
  <div class="mobile-nav-grid">
    <div class="mobile-nav-item active" id="mob-dashboard" onclick="showPage('dashboard')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Home
    </div>
    <div class="mobile-nav-item" id="mob-search" onclick="showPage('search')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35" stroke-linecap="round"/></svg>
      Discover
    </div>
    <div class="mobile-nav-item" id="mob-library" onclick="showPage('library')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
      Library
    </div>
    <div class="mobile-nav-item" id="mob-stats" onclick="showPage('stats')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      Stats
    </div>
    <div class="mobile-nav-item" id="mob-settings" onclick="showPage('settings')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      Settings
    </div>
  </div>
</nav>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toast-container"></div>

<!-- ===== ADD / EDIT BOOK MODAL ===== -->
<div class="modal-overlay" id="book-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">Add Book</div>
      <button class="modal-close" onclick="closeModal('book-modal')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="edit-book-id"/>

      <!-- Cover section -->
      <div class="modal-book-hero" id="modal-book-hero">
        <div style="display:flex; flex-direction:column; align-items:center; gap:8px;">
          <div class="modal-cover" id="modal-cover-preview">📚</div>
          <div class="cover-actions">
            <button class="cover-action-btn" onclick="refreshCover()">🔄 Refresh</button>
            <button class="cover-action-btn" onclick="document.getElementById('cover-url-input').focus()">🔗 URL</button>
          </div>
        </div>
        <div class="modal-book-info" id="modal-book-info-display" style="display:none;">
          <div class="modal-book-title" id="modal-book-title-display"></div>
          <div class="modal-book-author" id="modal-book-author-display"></div>
          <div class="modal-book-desc" id="modal-book-desc-display"></div>
        </div>
      </div>

      <!-- Cover URL input -->
      <div class="form-group">
        <label class="form-label">Cover Image URL (paste to override)</label>
        <div class="cover-url-group">
          <input type="url" class="form-input" id="cover-url-input" placeholder="https://..." oninput="updateCoverPreview()"/>
          <button class="btn btn-secondary" onclick="refreshCover()">🔄</button>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Title *</label>
          <input type="text" class="form-input" id="f-title" placeholder="Book title" oninput="updateModalTitle()"/>
        </div>
        <div class="form-group">
          <label class="form-label">Author *</label>
          <input type="text" class="form-input" id="f-author" placeholder="Author name" oninput="updateModalTitle()"/>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Genre</label>
          <input type="text" class="form-input" id="f-genre" placeholder="e.g. Fantasy, Horror"/>
        </div>
        <div class="form-group">
          <label class="form-label">ISBN / ID</label>
          <input type="text" class="form-input" id="f-isbn" placeholder="ISBN or Google Books ID"/>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Reading Status</label>
          <select class="form-select" id="f-status">
            <option value="want">Want to Read</option>
            <option value="reading">Currently Reading</option>
            <option value="read">Read</option>
            <option value="dnf">Did Not Finish</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Date Started</label>
          <input type="date" class="form-input" id="f-date-started"/>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Date Read / Finished</label>
          <input type="date" class="form-input" id="f-date-read"/>
        </div>
        <div class="form-group">
          <label class="form-label">Pages</label>
          <input type="number" class="form-input" id="f-pages" placeholder="0"/>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Pages Read</label>
          <input type="number" class="form-input" id="f-pages-read" placeholder="0"/>
        </div>
        <div class="form-group"></div>
      </div>

      <div class="form-group">
        <label class="form-label">Your Rating</label>
        <div class="star-rating" id="star-rating">
          <button class="star-btn" data-val="1" onclick="setRating(1)">★</button>
          <button class="star-btn" data-val="2" onclick="setRating(2)">★</button>
          <button class="star-btn" data-val="3" onclick="setRating(3)">★</button>
          <button class="star-btn" data-val="4" onclick="setRating(4)">★</button>
          <button class="star-btn" data-val="5" onclick="setRating(5)">★</button>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Ownership</label>
        <div class="checkbox-row" id="ownership-row">
          <label class="checkbox-item" id="own-physical-lbl">
            <input type="checkbox" id="own-physical" onchange="toggleCheckbox('own-physical-lbl', 'own-physical')"/> 📖 Physical Copy
          </label>
          <label class="checkbox-item" id="own-digital-lbl">
            <input type="checkbox" id="own-digital" onchange="toggleCheckbox('own-digital-lbl', 'own-digital')"/> 💻 Digital Copy
          </label>
          <label class="checkbox-item" id="own-borrowed-lbl">
            <input type="checkbox" id="own-borrowed" onchange="toggleCheckbox('own-borrowed-lbl', 'own-borrowed')"/> 🤝 Borrowed
          </label>
        </div>
      </div>

      <div class="form-row" id="copies-row">
        <div class="form-group">
          <label class="form-label">Number of Physical Copies</label>
          <input type="number" class="form-input" id="f-copies" placeholder="1" min="0"/>
        </div>
        <div class="form-group">
          <label class="form-label">Borrowed From</label>
          <input type="text" class="form-input" id="f-borrowed-from" placeholder="Name of person/library"/>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Collections</label>
        <div id="collection-checkboxes" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:4px;"></div>
      </div>

      <div class="form-group">
        <label class="form-label">Notes / Review</label>
        <textarea class="form-textarea" id="f-notes" placeholder="Your thoughts, notes, favourite quotes..."></textarea>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" id="delete-book-btn" onclick="deleteCurrentBook()" style="margin-right:auto; color:var(--red); display:none;">
        Delete
      </button>
      <button class="btn btn-secondary" onclick="closeModal('book-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveBook()">Save Book</button>
    </div>
  </div>
</div>

<!-- NEW COLLECTION MODAL -->
<div class="modal-overlay" id="collection-modal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-header">
      <div class="modal-title">New Collection</div>
      <button class="modal-close" onclick="closeModal('collection-modal')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Collection Name</label>
        <input type="text" class="form-input" id="col-name" placeholder="e.g. Horror, LGBTQ+, Classics..."/>
      </div>
      <div class="form-group">
        <label class="form-label">Emoji Icon</label>
        <div style="display:flex; flex-wrap:wrap; gap:6px;">
          <span class="emoji-opt" style="font-size:22px; cursor:pointer; padding:4px 8px; border-radius:6px; border:1px solid var(--border);" onclick="selectEmoji(this,'📚')">📚</span>
          <span class="emoji-opt" style="font-size:22px; cursor:pointer; padding:4px 8px; border-radius:6px; border:1px solid var(--border);" onclick="selectEmoji(this,'👻')">👻</span>
          <span class="emoji-opt" style="font-size:22px; cursor:pointer; padding:4px 8px; border-radius:6px; border:1px solid var(--border);" onclick="selectEmoji(this,'🏳️‍🌈')">🏳️‍🌈</span>
          <span class="emoji-opt" style="font-size:22px; cursor:pointer; padding:4px 8px; border-radius:6px; border:1px solid var(--border);" onclick="selectEmoji(this,'💫')">💫</span>
          <span class="emoji-opt" style="font-size:22px; cursor:pointer; padding:4px 8px; border-radius:6px; border:1px solid var(--border);" onclick="selectEmoji(this,'🔥')">🔥</span>
          <span class="emoji-opt" style="font-size:22px; cursor:pointer; padding:4px 8px; border-radius:6px; border:1px solid var(--border);" onclick="selectEmoji(this,'💜')">💜</span>
          <span class="emoji-opt" style="font-size:22px; cursor:pointer; padding:4px 8px; border-radius:6px; border:1px solid var(--border);" onclick="selectEmoji(this,'🌙')">🌙</span>
          <span class="emoji-opt" style="font-size:22px; cursor:pointer; padding:4px 8px; border-radius:6px; border:1px solid var(--border);" onclick="selectEmoji(this,'⚔️')">⚔️</span>
          <span class="emoji-opt" style="font-size:22px; cursor:pointer; padding:4px 8px; border-radius:6px; border:1px solid var(--border);" onclick="selectEmoji(this,'🌺')">🌺</span>
          <span class="emoji-opt" style="font-size:22px; cursor:pointer; padding:4px 8px; border-radius:6px; border:1px solid var(--border);" onclick="selectEmoji(this,'🏆')">🏆</span>
          <span class="emoji-opt" style="font-size:22px; cursor:pointer; padding:4px 8px; border-radius:6px; border:1px solid var(--border);" onclick="selectEmoji(this,'🌍')">🌍</span>
          <span class="emoji-opt" style="font-size:22px; cursor:pointer; padding:4px 8px; border-radius:6px; border:1px solid var(--border);" onclick="selectEmoji(this,'💡')">💡</span>
        </div>
        <input type="hidden" id="col-emoji" value="📚"/>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('collection-modal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveCollection()">Create Collection</button>
    </div>
  </div>
</div>

<!-- BOOK DETAIL MODAL (view only) -->
<div class="modal-overlay" id="book-detail-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Book Details</div>
      <button class="modal-close" onclick="closeModal('book-detail-modal')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="modal-body" id="book-detail-body"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('book-detail-modal')">Close</button>
      <button class="btn btn-primary" id="detail-edit-btn">Edit Book</button>
    </div>
  </div>
</div>

<script>
// ===================================================
//  SHELFWISE - Firebase-Integrated Application Logic
// ===================================================

// ---- STATE ----
let books = [];
let collections = [];
let settings = { theme: 'dark', goal: 0, goalYear: new Date().getFullYear() };
let currentRating = 0;
let currentStatusFilter = 'all';
let currentView = 'grid';
let currentSortBy = 'dateAdded';
let selectedEmoji = '📚';
let editingBookId = null;
let lastSearchResults = [];
let coverRefreshAttempts = {};
let currentUser = null;
let unsubscribeBooks = null;
let unsubscribeCollections = null;
let syncTimeout = null;

// ---- FIREBASE HELPERS ----
function fb() { return window._fb; }
function uid() { return currentUser?.uid; }

function setSyncStatus(status) {
  const dot = document.getElementById('sync-dot');
  if (!dot) return;
  dot.className = 'sync-dot' + (status === 'syncing' ? ' syncing' : status === 'error' ? ' error' : '');
  dot.title = status === 'syncing' ? 'Syncing...' : status === 'error' ? 'Sync error' : 'Synced to cloud';
}

// ---- FIRESTORE PATHS ----
function booksCol() { return fb().collection(fb().db, 'users', uid(), 'books'); }
function collectionsCol() { return fb().collection(fb().db, 'users', uid(), 'collections'); }
function settingsDoc() { return fb().doc(fb().db, 'users', uid(), 'config', 'settings'); }

// ---- SAVE TO FIRESTORE ----
async function saveBookToFirestore(book) {
  if (!uid()) return;
  setSyncStatus('syncing');
  try {
    await fb().setDoc(fb().doc(booksCol(), book.id), { ...book, updatedAt: fb().serverTimestamp() });
    setSyncStatus('synced');
  } catch(e) { setSyncStatus('error'); console.error(e); }
}

async function deleteBookFromFirestore(bookId) {
  if (!uid()) return;
  setSyncStatus('syncing');
  try {
    await fb().deleteDoc(fb().doc(booksCol(), bookId));
    setSyncStatus('synced');
  } catch(e) { setSyncStatus('error'); }
}

async function saveCollectionToFirestore(col) {
  if (!uid()) return;
  try {
    await fb().setDoc(fb().doc(collectionsCol(), col.id), col);
  } catch(e) { console.error(e); }
}

async function saveSettingsToFirestore() {
  if (!uid()) return;
  clearTimeout(syncTimeout);
  syncTimeout = setTimeout(async () => {
    try {
      await fb().setDoc(settingsDoc(), settings);
    } catch(e) { console.error(e); }
  }, 800);
}

// ---- SUBSCRIBE TO REALTIME UPDATES ----
function subscribeToData() {
  // Unsubscribe existing listeners
  if (unsubscribeBooks) unsubscribeBooks();
  if (unsubscribeCollections) unsubscribeCollections();

  // Books realtime
  unsubscribeBooks = fb().onSnapshot(booksCol(), snap => {
    books = snap.docs.map(d => ({ ...d.data(), id: d.id }));
    books.sort((a,b) => (b.dateAdded||0) - (a.dateAdded||0));
    renderLibrary();
    refreshDashboard();
    updateLibCount();
  }, err => {
    console.error('Books sync error:', err);
    setSyncStatus('error');
  });

  // Collections realtime
  unsubscribeCollections = fb().onSnapshot(collectionsCol(), snap => {
    collections = snap.docs.map(d => ({ ...d.data(), id: d.id }));
    renderCollections();
    refreshDashboard();
  });
}

async function loadSettings() {
  if (!uid()) return;
  try {
    const snap = await fb().getDoc(settingsDoc());
    if (snap.exists()) {
      settings = { ...settings, ...snap.data() };
      applyTheme();
      const gi = document.getElementById('goal-input');
      if (gi && settings.goal) gi.value = settings.goal;
    }
  } catch(e) { console.error(e); }
}

// ---- LOCAL STORAGE FALLBACK (offline support) ----
function saveLocal() {
  try {
    localStorage.setItem('sw_books', JSON.stringify(books));
    localStorage.setItem('sw_collections', JSON.stringify(collections));
    localStorage.setItem('sw_settings', JSON.stringify(settings));
  } catch(e) {}
}
function loadLocal() {
  try {
    const b = localStorage.getItem('sw_books');
    const c = localStorage.getItem('sw_collections');
    const s = localStorage.getItem('sw_settings');
    if (b) books = JSON.parse(b);
    if (c) collections = JSON.parse(c);
    if (s) settings = { ...settings, ...JSON.parse(s) };
  } catch(e) {}
}
// Keep local as cache
function save() {
  saveLocal();
  saveSettingsToFirestore();
}

// ---- AUTH FUNCTIONS ----
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (i===0) === (tab==='signin')));
  document.getElementById('auth-signin').classList.toggle('active', tab === 'signin');
  document.getElementById('auth-signup').classList.toggle('active', tab === 'signup');
}

async function authSignIn() {
  const email = document.getElementById('signin-email').value.trim();
  const password = document.getElementById('signin-password').value;
  const errEl = document.getElementById('signin-error');
  errEl.classList.remove('show');
  if (!email || !password) { showAuthError(errEl, 'Please fill in all fields'); return; }
  try {
    await fb().signInWithEmailAndPassword(fb().auth, email, password);
  } catch(e) {
    showAuthError(errEl, friendlyAuthError(e.code));
  }
}

async function authSignUp() {
  const name = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const password = document.getElementById('signup-password').value;
  const errEl = document.getElementById('signup-error');
  errEl.classList.remove('show');
  if (!email || !password) { showAuthError(errEl, 'Please fill in all fields'); return; }
  try {
    const cred = await fb().createUserWithEmailAndPassword(fb().auth, email, password);
    // Store display name in settings
    if (name) {
      settings.displayName = name;
      await saveSettingsToFirestore();
    }
  } catch(e) {
    showAuthError(errEl, friendlyAuthError(e.code));
  }
}

async function authWithGoogle() {
  try {
    await fb().signInWithPopup(fb().auth, fb().googleProvider);
  } catch(e) {
    if (e.code !== 'auth/popup-closed-by-user') {
      showToast('Google sign-in failed: ' + friendlyAuthError(e.code), 'error');
    }
  }
}

async function authForgotPassword() {
  const email = document.getElementById('signin-email').value.trim();
  if (!email) { showAuthError(document.getElementById('signin-error'), 'Enter your email address first'); return; }
  try {
    await fb().sendPasswordResetEmail(fb().auth, email);
    showToast('Password reset email sent!', 'success');
  } catch(e) {
    showAuthError(document.getElementById('signin-error'), friendlyAuthError(e.code));
  }
}

async function authSignOut() {
  if (!confirm('Sign out of ConnieReads?')) return;
  if (unsubscribeBooks) unsubscribeBooks();
  if (unsubscribeCollections) unsubscribeCollections();
  books = []; collections = [];
  await fb().signOut(fb().auth);
}

function showAuthError(el, msg) {
  el.textContent = msg;
  el.classList.add('show');
}

function friendlyAuthError(code) {
  const map = {
    'auth/invalid-email': 'Invalid email address.',
    'auth/user-not-found': 'No account found with this email.',
    'auth/wrong-password': 'Incorrect password.',
    'auth/email-already-in-use': 'An account already exists with this email.',
    'auth/weak-password': 'Password must be at least 6 characters.',
    'auth/too-many-requests': 'Too many attempts. Please try again later.',
    'auth/network-request-failed': 'Network error. Check your connection.',
    'auth/invalid-credential': 'Invalid email or password.',
  };
  return map[code] || 'Something went wrong. Please try again.';
}

function updateUserUI(user) {
  const nameEl = document.getElementById('user-display-name');
  const avatarEl = document.getElementById('user-avatar');
  if (!user) return;
  const displayName = user.displayName || settings.displayName || user.email?.split('@')[0] || 'Reader';
  if (nameEl) nameEl.textContent = displayName;
  if (avatarEl) {
    if (user.photoURL) {
      avatarEl.innerHTML = `<img src="${user.photoURL}" alt=""/>`;
    } else {
      avatarEl.textContent = displayName[0].toUpperCase();
    }
  }
  // Update greeting
  const greetEl = document.querySelector('.greeting h1');
  if (greetEl) greetEl.innerHTML = `Welcome back, <span>${displayName.split(' ')[0]}</span>`;
}

// ---- AUTH STATE HANDLER ----
window._onAuthReady = async (user) => {
  const authScreen = document.getElementById('auth-screen');
  const authLoading = document.getElementById('auth-loading');
  const authForms = document.getElementById('auth-forms');

  if (user) {
    currentUser = user;
    authScreen.classList.add('hidden');
    updateUserUI(user);
    setSyncStatus('syncing');
    await loadSettings();
    subscribeToData();
    refreshDashboard();
    setSyncStatus('synced');
  } else {
    currentUser = null;
    books = []; collections = [];
    authScreen.classList.remove('hidden');
    authLoading.classList.remove('show');
    authForms.style.display = 'block';
    renderLibrary();
    refreshDashboard();
  }
};

// ---- NAVIGATION ----
const pageTitles = { dashboard:'Dashboard', search:'Discover', library:'My Library', collections:'Collections', stats:'Statistics', settings:'Settings' };
function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.querySelectorAll('.mobile-nav-item').forEach(n => n.classList.remove('active'));

  const el = document.getElementById('page-' + page);
  if (el) el.classList.add('active');
  document.querySelector(`[onclick="showPage('${page}')"]`)?.classList.add('active');
  const mob = document.getElementById('mob-' + page);
  if (mob) mob.classList.add('active');

  document.getElementById('page-title').textContent = pageTitles[page] || page;
  document.getElementById('top-search-wrap').style.display = (page === 'library') ? 'block' : 'none';
  document.getElementById('add-book-btn').style.display = (page === 'settings') ? 'none' : 'flex';
  closeSidebar();

  if (page === 'dashboard') refreshDashboard();
  if (page === 'library') renderLibrary();
  if (page === 'collections') renderCollections();
  if (page === 'stats') renderStats();
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebar-backdrop').classList.toggle('open');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-backdrop').classList.remove('open');
}

// ---- THEME ----
function applyTheme() {
  const isDark = settings.theme === 'dark';
  document.documentElement.setAttribute('data-theme', settings.theme);
  document.querySelector('.toggle-switch')?.classList.toggle('on', isDark);
  const tts = document.getElementById('theme-toggle-settings');
  if (tts) tts.classList.toggle('on', isDark);
  const themeBtn = document.querySelector('.theme-toggle');
  if (themeBtn) {
    const txt = themeBtn.childNodes[2];
    if (txt) txt.textContent = isDark ? ' Light Mode' : ' Dark Mode';
  }
}

function toggleTheme() {
  settings.theme = settings.theme === 'dark' ? 'light' : 'dark';
  applyTheme();
  save();
}

// ---- MODALS ----
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ---- ADD/EDIT BOOK MODAL ----
function openAddModal(prefill = null) {
  editingBookId = null;
  currentRating = 0;
  document.getElementById('modal-title').textContent = 'Add Book';
  document.getElementById('delete-book-btn').style.display = 'none';
  clearBookForm();
  if (prefill) {
    document.getElementById('f-title').value = prefill.title || '';
    document.getElementById('f-author').value = prefill.author || '';
    document.getElementById('f-genre').value = prefill.genre || '';
    document.getElementById('f-isbn').value = prefill.isbn || '';
    document.getElementById('f-pages').value = prefill.pages || '';
    document.getElementById('cover-url-input').value = prefill.coverUrl || '';
    updateCoverPreview();
    updateModalTitle();
    if (prefill.description) {
      document.getElementById('modal-book-info-display').style.display = 'block';
      document.getElementById('modal-book-title-display').textContent = prefill.title || '';
      document.getElementById('modal-book-author-display').textContent = prefill.author || '';
      document.getElementById('modal-book-desc-display').textContent = prefill.description || '';
    }
  }
  renderCollectionCheckboxes([]);
  openModal('book-modal');
}

function openEditModal(bookId) {
  const book = books.find(b => b.id === bookId);
  if (!book) return;
  editingBookId = bookId;
  currentRating = book.rating || 0;
  document.getElementById('modal-title').textContent = 'Edit Book';
  document.getElementById('delete-book-btn').style.display = 'flex';
  document.getElementById('edit-book-id').value = bookId;
  document.getElementById('f-title').value = book.title || '';
  document.getElementById('f-author').value = book.author || '';
  document.getElementById('f-genre').value = book.genre || '';
  document.getElementById('f-isbn').value = book.isbn || '';
  document.getElementById('f-status').value = book.status || 'want';
  document.getElementById('f-date-read').value = book.dateRead || '';
  document.getElementById('f-date-started').value = book.dateStarted || '';
  document.getElementById('f-pages').value = book.pages || '';
  document.getElementById('f-pages-read').value = book.pagesRead || '';
  document.getElementById('f-copies').value = book.copies || '';
  document.getElementById('f-borrowed-from').value = book.borrowedFrom || '';
  document.getElementById('f-notes').value = book.notes || '';
  document.getElementById('cover-url-input').value = book.coverUrl || '';
  updateCoverPreview();
  updateModalTitle();
  updateStars(currentRating);

  const physLbl = document.getElementById('own-physical-lbl');
  const digLbl = document.getElementById('own-digital-lbl');
  const borLbl = document.getElementById('own-borrowed-lbl');
  document.getElementById('own-physical').checked = book.ownPhysical || false;
  document.getElementById('own-digital').checked = book.ownDigital || false;
  document.getElementById('own-borrowed').checked = book.ownBorrowed || false;
  physLbl.classList.toggle('checked', book.ownPhysical || false);
  digLbl.classList.toggle('checked', book.ownDigital || false);
  borLbl.classList.toggle('checked', book.ownBorrowed || false);

  if (book.description) {
    document.getElementById('modal-book-info-display').style.display = 'block';
    document.getElementById('modal-book-title-display').textContent = book.title || '';
    document.getElementById('modal-book-author-display').textContent = book.author || '';
    document.getElementById('modal-book-desc-display').textContent = book.description || '';
  }

  renderCollectionCheckboxes(book.collections || []);
  openModal('book-modal');
}

function clearBookForm() {
  ['f-title','f-author','f-genre','f-isbn','f-date-read','f-date-started','f-notes','f-copies','f-borrowed-from','cover-url-input','f-pages','f-pages-read'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('f-status').value = 'want';
  document.getElementById('own-physical').checked = false;
  document.getElementById('own-digital').checked = false;
  document.getElementById('own-borrowed').checked = false;
  document.getElementById('own-physical-lbl').classList.remove('checked');
  document.getElementById('own-digital-lbl').classList.remove('checked');
  document.getElementById('own-borrowed-lbl').classList.remove('checked');
  document.getElementById('modal-cover-preview').innerHTML = '📚';
  document.getElementById('modal-book-info-display').style.display = 'none';
  currentRating = 0;
  updateStars(0);
}

function updateModalTitle() {
  const title = document.getElementById('f-title').value;
  const author = document.getElementById('f-author').value;
  if (title || author) {
    document.getElementById('modal-book-info-display').style.display = 'block';
    document.getElementById('modal-book-title-display').textContent = title;
    document.getElementById('modal-book-author-display').textContent = author;
  }
  // Refresh spine preview live as user types title
  const url = document.getElementById('cover-url-input').value.trim();
  if (!url && (title || author)) updateCoverPreview();
}

function updateCoverPreview() {
  const url = document.getElementById('cover-url-input').value.trim();
  const title = document.getElementById('f-title').value.trim();
  const author = document.getElementById('f-author').value.trim();
  const preview = document.getElementById('modal-cover-preview');
  if (url) {
    const fakeBook = { title, author, coverUrl: url };
    preview.innerHTML = bookCoverImg(fakeBook, 'spine-lg');
  } else if (title) {
    preview.innerHTML = bookSpineHTML({ title, author }, 'spine-lg');
  } else {
    preview.innerHTML = '📚';
  }
}

function toggleCheckbox(labelId, inputId) {
  const input = document.getElementById(inputId);
  const label = document.getElementById(labelId);
  if (input && label) label.classList.toggle('checked', input.checked);
}

function setRating(val) {
  currentRating = currentRating === val ? 0 : val;
  updateStars(currentRating);
}

function updateStars(val) {
  document.querySelectorAll('.star-btn').forEach(btn => {
    btn.classList.toggle('active', parseInt(btn.dataset.val) <= val);
  });
}

function renderCollectionCheckboxes(selected = []) {
  const cont = document.getElementById('collection-checkboxes');
  if (collections.length === 0) {
    cont.innerHTML = '<span style="font-size:12px;color:var(--text-muted);">No collections yet. Create one in Collections.</span>';
    return;
  }
  cont.innerHTML = collections.map(col => `
    <label class="checkbox-item ${selected.includes(col.id) ? 'checked' : ''}" id="col-check-${col.id}" style="margin:2px;">
      <input type="checkbox" value="${col.id}" ${selected.includes(col.id) ? 'checked' : ''} 
        onchange="this.closest('label').classList.toggle('checked', this.checked)"/>
      ${col.emoji} ${col.name}
    </label>
  `).join('');
}

async function saveBook() {
  const title = document.getElementById('f-title').value.trim();
  const author = document.getElementById('f-author').value.trim();
  if (!title) { showToast('Please enter a book title', 'error'); return; }
  if (!uid()) { showToast('Please sign in to save books', 'error'); return; }

  const selectedCols = Array.from(document.querySelectorAll('#collection-checkboxes input:checked')).map(i => i.value);
  const coverUrl = document.getElementById('cover-url-input').value.trim();

  const bookData = {
    title,
    author: author || 'Unknown',
    genre: document.getElementById('f-genre').value.trim(),
    isbn: document.getElementById('f-isbn').value.trim(),
    status: document.getElementById('f-status').value,
    dateRead: document.getElementById('f-date-read').value,
    dateStarted: document.getElementById('f-date-started').value,
    pages: parseInt(document.getElementById('f-pages').value) || 0,
    pagesRead: parseInt(document.getElementById('f-pages-read').value) || 0,
    rating: currentRating,
    ownPhysical: document.getElementById('own-physical').checked,
    ownDigital: document.getElementById('own-digital').checked,
    ownBorrowed: document.getElementById('own-borrowed').checked,
    copies: parseInt(document.getElementById('f-copies').value) || (document.getElementById('own-physical').checked ? 1 : 0),
    borrowedFrom: document.getElementById('f-borrowed-from').value.trim(),
    notes: document.getElementById('f-notes').value.trim(),
    coverUrl,
    collections: selectedCols,
    description: document.getElementById('modal-book-desc-display').textContent || '',
  };

  closeModal('book-modal');

  if (editingBookId) {
    const existing = books.find(b => b.id === editingBookId);
    const updated = { ...existing, ...bookData, updatedAt: Date.now() };
    await saveBookToFirestore(updated);
    showToast(`"${title}" updated`, 'success');
    addActivity(`Updated <strong>${title}</strong>`, '✏️', '#6a9bbf');
  } else {
    const book = { id: genId(), ...bookData, dateAdded: Date.now() };
    await saveBookToFirestore(book);
    showToast(`"${title}" added to library`, 'success');
    addActivity(`Added <strong>${title}</strong> by ${author || 'Unknown'}`, '📚', '#d4884a');
  }
}

async function deleteCurrentBook() {
  if (!editingBookId) return;
  const book = books.find(b => b.id === editingBookId);
  if (!book) return;
  if (!confirm(`Delete "${book.title}"? This cannot be undone.`)) return;
  addActivity(`Removed <strong>${book.title}</strong>`, '🗑️', '#c0605a');
  closeModal('book-modal');
  await deleteBookFromFirestore(editingBookId);
  showToast(`"${book.title}" deleted`, 'info');
}

// ---- COVER SEARCH (Google Books + Open Library + Hardcover) ----
async function refreshCover() {
  const title = document.getElementById('f-title').value.trim();
  const author = document.getElementById('f-author').value.trim();
  const isbn = document.getElementById('f-isbn').value.trim();
  if (!title && !isbn) { showToast('Enter a title or ISBN first', 'error'); return; }

  showToast('Searching for cover...', 'info');
  const key = isbn || `${title} ${author}`;
  coverRefreshAttempts[key] = (coverRefreshAttempts[key] || 0) + 1;

  const sources = [
    // Google Books
    `https://books.google.com/books/content?q=${encodeURIComponent(title + ' ' + author)}&img=1&zoom=1&size=large`,
    // Open Library ISBN
    isbn ? `https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg` : null,
    // Open Library title
    `https://covers.openlibrary.org/b/title/${encodeURIComponent(title)}-L.jpg`,
    // Open Library ISBN medium
    isbn ? `https://covers.openlibrary.org/b/isbn/${isbn}-M.jpg` : null,
    // Hardcover (via Open Library fallback path)
    isbn ? `https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg?default=false` : null,
  ].filter(Boolean);

  const source = sources[coverRefreshAttempts[key] % sources.length];
  document.getElementById('cover-url-input').value = source;
  updateCoverPreview();
  showToast(`Trying source ${(coverRefreshAttempts[key] % sources.length) + 1}/${sources.length} — check preview!`, 'success');
}

// Try to auto-fetch best cover from Hardcover API (GraphQL) then fall back to Google Books
async function fetchBestCover(title, author, isbn) {
  // Try Hardcover GraphQL first
  try {
    const hcQuery = `{"query":"query { books(where: {title: {_ilike: \\"${title.replace(/"/g, '')}\\"}} limit: 1) { image { url } } }"}`;
    const hcRes = await fetch('https://api.hardcover.app/v1/graphql', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: hcQuery
    });
    if (hcRes.ok) {
      const hcData = await hcRes.json();
      const url = hcData?.data?.books?.[0]?.image?.url;
      if (url) return url;
    }
  } catch(e) { /* fall through */ }

  // Fall back to Google Books
  try {
    const q = isbn ? `isbn:${isbn}` : encodeURIComponent(`${title} ${author}`);
    const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${q}&maxResults=1`);
    const data = await res.json();
    const imgLinks = data.items?.[0]?.volumeInfo?.imageLinks;
    if (imgLinks) {
      return (imgLinks.extraLarge || imgLinks.large || imgLinks.thumbnail || '').replace('http:', 'https:');
    }
  } catch(e) {}

  return '';
}

// ---- GOOGLE BOOKS SEARCH ----
async function searchBooks(query) {
  const input = document.getElementById('discover-search');
  const q = query || input.value.trim();
  if (!q) return;
  input.value = q;
  showPage('search');

  const grid = document.getElementById('search-results-grid');
  grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-muted);">🔍 Searching...</div>';

  try {
    const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&maxResults=20`);
    const data = await res.json();
    lastSearchResults = (data.items || []).map(item => {
      const info = item.volumeInfo || {};
      const imgLinks = info.imageLinks || {};
      return {
        id: item.id,
        title: info.title || 'Unknown Title',
        author: (info.authors || ['Unknown']).join(', '),
        genre: (info.categories || []).join(', '),
        pages: info.pageCount || 0,
        description: info.description || '',
        isbn: (info.industryIdentifiers || []).find(i => i.type === 'ISBN_13')?.identifier || item.id,
        coverUrl: (imgLinks.thumbnail || imgLinks.smallThumbnail || '').replace('http:', 'https:')
      };
    });
    renderSearchResults(lastSearchResults);
  } catch(e) {
    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--red);">Search failed. Check your connection and try again.</div>';
  }
}

function renderSearchResults(results) {
  const grid = document.getElementById('search-results-grid');
  if (!results.length) {
    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-muted);">No results found. Try a different search.</div>';
    return;
  }
  grid.innerHTML = results.map((book, i) => {
    const inLib = books.some(b => b.isbn === book.isbn || b.title.toLowerCase() === book.title.toLowerCase());
    const coverHtml = book.coverUrl 
      ? `<img src="${book.coverUrl}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" alt="${escHtml(book.title)}"/><div style="display:none;width:100%;height:100%;">${bookSpineHTML(book)}</div>`
      : bookSpineHTML(book);
    return `
      <div class="search-result-card" style="animation-delay:${i * 0.04}s">
        <div class="search-cover">${coverHtml}</div>
        <div class="search-book-title">${escHtml(book.title)}</div>
        <div class="search-book-author">${escHtml(book.author)}</div>
        <button class="search-add-btn ${inLib ? 'added' : ''}" onclick="addFromSearch(${i})">
          ${inLib ? '✓ In Library' : '+ Add to Library'}
        </button>
      </div>
    `;
  }).join('');
}

function addFromSearch(index) {
  const book = lastSearchResults[index];
  openAddModal(book);
}

// ---- BOOK SPINE PLACEHOLDER GENERATOR ----
const SPINE_COLORS = [
  ['#7c3f1e','#a0552a'],['#1e3a5f','#2a5080'],['#2d5a1b','#3d7a26'],
  ['#5a1e3f','#7a2a55'],['#3f3f1e','#5a5a2a'],['#1e4a4a','#2a6a6a'],
  ['#5a2d1e','#7a3f2a'],['#1e1e5a','#2a2a7a'],['#4a1e5a','#6a2a7a'],
  ['#5a1e1e','#7a2a2a'],['#1e5a3a','#2a7a50'],['#3a1e5a','#502a7a'],
];

function getSpineColor(title) {
  let hash = 0;
  for (let i = 0; i < (title||'').length; i++) hash = ((hash << 5) - hash) + title.charCodeAt(i);
  return SPINE_COLORS[Math.abs(hash) % SPINE_COLORS.length];
}

function bookSpineHTML(book, sizeClass = '') {
  const [bg1, bg2] = getSpineColor(book.title || '');
  return `<div class="book-spine ${sizeClass}" style="background:linear-gradient(135deg, ${bg1}, ${bg2});">
    <div class="book-spine-title">${escHtml(book.title || '')}</div>
    <div class="book-spine-author">${escHtml(book.author || '')}</div>
  </div>`;
}

function bookCoverImg(book, fallbackSizeClass = '') {
  if (book.coverUrl) {
    return `<img src="${escHtml(book.coverUrl)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';" alt="${escHtml(book.title)}"/><div style="display:none;width:100%;height:100%;">${bookSpineHTML(book, fallbackSizeClass)}</div>`;
  }
  return bookSpineHTML(book, fallbackSizeClass);
}

// ---- RENDER BOOK CARD ----
function renderLibrary() {
  const filter = (document.getElementById('lib-filter')?.value || '').toLowerCase();
  let filtered = books.filter(b => {
    const matchStatus = currentStatusFilter === 'all' || b.status === currentStatusFilter;
    const matchFilter = !filter || 
      b.title.toLowerCase().includes(filter) || 
      b.author.toLowerCase().includes(filter) ||
      (b.genre || '').toLowerCase().includes(filter);
    return matchStatus && matchFilter;
  });

  filtered.sort((a, b) => {
    if (currentSortBy === 'title') return a.title.localeCompare(b.title);
    if (currentSortBy === 'author') return a.author.localeCompare(b.author);
    if (currentSortBy === 'rating') return (b.rating || 0) - (a.rating || 0);
    if (currentSortBy === 'dateRead') return (b.dateRead || '').localeCompare(a.dateRead || '');
    return (b.dateAdded || 0) - (a.dateAdded || 0);
  });

  const grid = document.getElementById('library-grid');
  const empty = document.getElementById('library-empty');

  if (filtered.length === 0) {
    grid.innerHTML = '';
    grid.style.display = 'none';
    empty.style.display = 'block';
    return;
  }
  grid.style.display = '';
  empty.style.display = 'none';

  if (currentView === 'grid') {
    grid.className = 'books-grid';
    grid.innerHTML = filtered.map((book, i) => renderBookCard(book, i)).join('');
  } else {
    grid.className = 'books-list';
    grid.innerHTML = filtered.map((book, i) => renderBookListItem(book, i)).join('');
  }
}

function renderBookCard(book, i) {
  const stars = book.rating ? '★'.repeat(book.rating) : '';
  const ownerBadge = book.ownBorrowed 
    ? `<div class="cover-badge borrowed">B</div>` 
    : (book.ownPhysical || book.ownDigital) 
      ? `<div class="cover-badge owned">✓</div>` : '';
  return `
    <div class="book-card" onclick="openBookDetail('${book.id}')" style="animation-delay:${i*0.03}s">
      <div class="book-cover-lg">${bookCoverImg(book)}${ownerBadge}</div>
      <div class="book-card-title">${escHtml(book.title)}</div>
      <div class="book-card-author">${escHtml(book.author)}</div>
      <div class="book-card-meta">
        <span class="status-badge status-${book.status}">${statusLabel(book.status)}</span>
        ${stars ? `<span class="stars-small">${stars}</span>` : ''}
      </div>
    </div>
  `;
}

function renderBookListItem(book, i) {
  const stars = book.rating ? '★'.repeat(book.rating) : '';
  const ownTags = [
    book.ownPhysical && '<span class="status-badge" style="background:var(--green-soft);color:var(--green);">📖 Physical</span>',
    book.ownDigital && '<span class="status-badge" style="background:var(--blue-soft);color:var(--blue);">💻 Digital</span>',
    book.ownBorrowed && '<span class="status-badge" style="background:var(--purple-soft);color:var(--purple);">🤝 Borrowed</span>',
  ].filter(Boolean).join('');
  return `
    <div class="book-list-item" onclick="openBookDetail('${book.id}')">
      <div class="book-list-cover">${bookCoverImg(book)}</div>
      <div class="book-list-info">
        <div class="book-list-title">${escHtml(book.title)}</div>
        <div class="book-list-author">${escHtml(book.author)}${book.genre ? ` · ${escHtml(book.genre)}` : ''}</div>
        <div class="book-list-badges">
          <span class="status-badge status-${book.status}">${statusLabel(book.status)}</span>
          ${ownTags}
        </div>
      </div>
      <div class="book-list-meta">
        ${stars ? `<span style="color:var(--star);font-size:13px;">${stars}</span>` : ''}
        ${book.pages ? `<span style="font-size:11px;color:var(--text-muted);">${book.pages}p</span>` : ''}
        <button class="btn btn-ghost" style="padding:4px 8px;font-size:12px;" onclick="event.stopPropagation();openEditModal('${book.id}')">Edit</button>
      </div>
    </div>
  `;
}

function filterLibrary() { renderLibrary(); }
function setStatusFilter(status, el) {
  currentStatusFilter = status;
  document.querySelectorAll('#page-library .filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderLibrary();
}
function setSortBy(val) { currentSortBy = val; renderLibrary(); }
function setView(view) {
  currentView = view;
  document.getElementById('grid-view-btn').classList.toggle('active', view === 'grid');
  document.getElementById('list-view-btn').classList.toggle('active', view === 'list');
  renderLibrary();
}

// ---- BOOK DETAIL ----
function openBookDetail(bookId) {
  const book = books.find(b => b.id === bookId);
  if (!book) return;
  const coverHtml = bookCoverImg(book, 'spine-lg');
  const stars = book.rating ? '★'.repeat(book.rating) + '☆'.repeat(5-book.rating) : '☆☆☆☆☆';
  const progress = book.pages && book.pagesRead ? Math.round((book.pagesRead / book.pages) * 100) : 0;
  const ownDetails = [
    book.ownPhysical && `📖 Physical Copy (${book.copies || 1})`,
    book.ownDigital && '💻 Digital Copy',
    book.ownBorrowed && `🤝 Borrowed${book.borrowedFrom ? ' from ' + book.borrowedFrom : ''}`,
  ].filter(Boolean).join(' &nbsp;·&nbsp; ');
  const colNames = (book.collections || []).map(cid => {
    const col = collections.find(c => c.id === cid);
    return col ? `${col.emoji} ${col.name}` : null;
  }).filter(Boolean).join(', ');

  const dateLine = [
    book.dateStarted && `📅 Started: ${book.dateStarted}`,
    book.dateRead && `✅ Finished: ${book.dateRead}`,
  ].filter(Boolean).join(' &nbsp;·&nbsp; ');

  document.getElementById('book-detail-body').innerHTML = `
    <div style="display:flex; gap:22px; margin-bottom:24px;">
      <div style="width:100px;height:150px;border-radius:6px;overflow:hidden;flex-shrink:0;background:var(--bg-elevated);box-shadow:4px 4px 16px rgba(0,0,0,0.35);">${coverHtml}</div>
      <div>
        <div style="font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--text-primary);margin-bottom:4px;">${escHtml(book.title)}</div>
        <div style="font-family:'Lora',serif;font-size:14px;font-style:italic;color:var(--text-secondary);margin-bottom:10px;">${escHtml(book.author)}</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
          <span class="status-badge status-${book.status}">${statusLabel(book.status)}</span>
          ${book.genre ? `<span class="status-badge" style="background:var(--bg-elevated);color:var(--text-secondary);">${escHtml(book.genre)}</span>` : ''}
        </div>
        <div style="color:var(--star);font-size:18px;margin-bottom:8px;">${stars}</div>
        ${book.pages ? `<div style="font-size:12px;color:var(--text-muted);">${book.pages} pages${book.pagesRead ? ` · ${book.pagesRead} read` : ''}</div>` : ''}
        ${progress ? `<div style="margin-top:8px;"><div style="height:4px;background:var(--bg-elevated);border-radius:2px;overflow:hidden;width:150px;"><div style="height:100%;background:var(--accent);width:${progress}%;border-radius:2px;"></div></div><div style="font-size:11px;color:var(--text-muted);margin-top:3px;">${progress}% read</div></div>` : ''}
      </div>
    </div>
    ${ownDetails ? `<div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;">${ownDetails}</div>` : ''}
    ${colNames ? `<div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Collections: ${colNames}</div>` : ''}
    ${dateLine ? `<div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">${dateLine}</div>` : ''}
    ${book.description ? `<div style="font-size:13px;color:var(--text-secondary);line-height:1.6;margin-bottom:16px;padding:14px;background:var(--bg-elevated);border-radius:9px;">${escHtml(book.description.substring(0,400))}${book.description.length > 400 ? '...' : ''}</div>` : ''}
    ${book.notes ? `<div style="margin-top:16px;"><div style="font-size:12px;font-weight:500;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Notes & Review</div><div style="font-size:13px;color:var(--text-secondary);line-height:1.6;white-space:pre-wrap;padding:14px;background:var(--bg-elevated);border-radius:9px;">${escHtml(book.notes)}</div></div>` : ''}
  `;
  document.getElementById('detail-edit-btn').onclick = () => { closeModal('book-detail-modal'); openEditModal(bookId); };
  openModal('book-detail-modal');
}

// ---- COLLECTIONS ----
function openNewCollectionModal() {
  document.getElementById('col-name').value = '';
  selectedEmoji = '📚';
  document.querySelectorAll('.emoji-opt').forEach(e => { e.style.background = ''; e.style.borderColor = ''; });
  openModal('collection-modal');
}

function selectEmoji(el, emoji) {
  document.querySelectorAll('.emoji-opt').forEach(e => { e.style.background = ''; e.style.borderColor = ''; });
  el.style.background = 'var(--accent-soft)';
  el.style.borderColor = 'var(--accent)';
  selectedEmoji = emoji;
  document.getElementById('col-emoji').value = emoji;
}

async function saveCollection() {
  const name = document.getElementById('col-name').value.trim();
  if (!name) { showToast('Enter a collection name', 'error'); return; }
  const col = { id: genId(), name, emoji: selectedEmoji, createdAt: Date.now() };
  closeModal('collection-modal');
  await saveCollectionToFirestore(col);
  showToast(`Collection "${name}" created`, 'success');
}

function renderCollections() {
  const grid = document.getElementById('collections-grid');
  grid.innerHTML = collections.map(col => {
    const colBooks = books.filter(b => (b.collections || []).includes(col.id));
    const coverPreviews = colBooks.slice(0, 4).map(b => `
      <div class="collection-cover-mini">${b.coverUrl ? `<img src="${b.coverUrl}" onerror="this.style.display='none';this.nextElementSibling.style.display='block';" alt=""/><div style="display:none;width:100%;height:100%;">${bookSpineHTML(b)}</div>` : bookSpineHTML(b)}</div>
    `).join('');
    const more = colBooks.length > 4 ? `<div class="collection-more">+${colBooks.length - 4}</div>` : '';
    return `
      <div class="collection-card">
        <div>
          <span class="collection-emoji">${col.emoji}</span>
          <div class="collection-name">${escHtml(col.name)}</div>
          <div class="collection-count">${colBooks.length} book${colBooks.length !== 1 ? 's' : ''}</div>
        </div>
        <div class="collection-covers">${coverPreviews}${more}</div>
      </div>
    `;
  }).join('') + `
    <div class="collection-card add-collection-card" onclick="openNewCollectionModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Create New Collection
    </div>
  `;
}

// ---- DASHBOARD ----
const activityLog = [];
function addActivity(text, icon, color) {
  activityLog.unshift({ text, icon, color, time: Date.now() });
  if (activityLog.length > 20) activityLog.pop();
}

function refreshDashboard() {
  const year = new Date().getFullYear();
  const readBooks = books.filter(b => b.status === 'read');
  const readThisYear = readBooks.filter(b => b.dateRead && b.dateRead.startsWith(year.toString()));
  const reading = books.filter(b => b.status === 'reading');
  const want = books.filter(b => b.status === 'want');

  document.getElementById('stat-total').textContent = books.length;
  document.getElementById('stat-read').textContent = readBooks.length;
  document.getElementById('stat-read-year').textContent = `${readThisYear.length} this year`;
  document.getElementById('stat-reading').textContent = reading.length;

  const goal = settings.goal || 0;
  document.getElementById('goal-year').textContent = year;
  document.getElementById('goal-year-setting').textContent = year;
  if (goal > 0) {
    const pct = Math.min(100, Math.round((readThisYear.length / goal) * 100));
    document.getElementById('stat-goal-pct').textContent = pct + '%';
    document.getElementById('stat-goal-detail').textContent = `${readThisYear.length}/${goal} books`;
    document.getElementById('goal-title-text').textContent = `Reading Goal ${year}`;
    document.getElementById('goal-count-text').innerHTML = `${readThisYear.length} <span>/ ${goal}</span>`;
    document.getElementById('goal-progress-fill').style.width = pct + '%';
    const remaining = goal - readThisYear.length;
    const daysLeft = Math.ceil((new Date(year, 11, 31) - new Date()) / 86400000);
    document.getElementById('goal-meta-text').textContent = remaining > 0 
      ? `${remaining} books to go · ${daysLeft} days left this year` 
      : `🎉 Goal achieved! You've read ${readThisYear.length} books this year.`;
  } else {
    document.getElementById('stat-goal-pct').textContent = '—';
    document.getElementById('stat-goal-detail').textContent = 'no goal set';
  }

  // Currently reading
  const crList = document.getElementById('currently-reading-list');
  if (reading.length) {
    crList.innerHTML = reading.map(book => {
      const progress = book.pages && book.pagesRead ? Math.round((book.pagesRead / book.pages) * 100) : 0;
      const cover = `<div class="book-cover-sm">${bookCoverImg(book)}</div>`;
      return `
        <div class="book-item-horizontal" onclick="openBookDetail('${book.id}')" style="cursor:pointer;">
          ${cover}
          <div class="book-info-sm">
            <div class="book-title-sm">${escHtml(book.title)}</div>
            <div class="book-author-sm">${escHtml(book.author)}</div>
            <div class="reading-progress">
              <div class="reading-progress-bar"><div class="reading-progress-fill" style="width:${progress}%"></div></div>
              <span class="reading-pct">${progress ? progress+'%' : 'In Progress'}</span>
            </div>
          </div>
        </div>
      `;
    }).join('');
  } else {
    crList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">No books in progress. Start reading!</div>';
  }

  // Want to read
  const wantList = document.getElementById('want-to-read-list');
  document.getElementById('want-count').textContent = `${want.length} book${want.length !== 1 ? 's' : ''}`;
  if (want.length) {
    wantList.innerHTML = want.slice(0, 5).map(book => `
      <div style="display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer;" onclick="openBookDetail('${book.id}')">
        <div style="width:28px;height:42px;border-radius:3px;overflow:hidden;flex-shrink:0;">
          ${bookCoverImg(book)}
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-size:13px;font-weight:500;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escHtml(book.title)}</div>
          <div style="font-size:11px;color:var(--text-muted);">${escHtml(book.author)}</div>
        </div>
      </div>
    `).join('');
  } else {
    wantList.innerHTML = '<div style="font-size:13px;color:var(--text-muted);">Your wish list is empty</div>';
  }

  // Activity
  const actList = document.getElementById('activity-list');
  if (activityLog.length) {
    actList.innerHTML = activityLog.slice(0, 8).map(a => `
      <div class="activity-item">
        <div class="activity-dot" style="background:${a.color}"></div>
        <div class="activity-text">${a.text}</div>
        <div class="activity-time">${timeAgo(a.time)}</div>
      </div>
    `).join('');
  } else {
    actList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">No activity yet. Add some books!</div>';
  }

  // Collections in dashboard
  const dashCols = document.getElementById('dash-collections');
  if (collections.length) {
    dashCols.innerHTML = collections.map(col => {
      const count = books.filter(b => (b.collections || []).includes(col.id)).length;
      return `<div class="collection-pill" onclick="showPage('collections')">${col.emoji} ${escHtml(col.name)} <span class="pill-count">${count}</span></div>`;
    }).join('');
  } else {
    dashCols.innerHTML = '<div style="font-size:13px;color:var(--text-muted);">No collections yet</div>';
  }

  updateLibCount();
}

function updateLibCount() {
  document.getElementById('lib-count').textContent = books.length;
}

// ---- STATS ----
function renderStats() {
  const readBooks = books.filter(b => b.status === 'read');
  const allBooks = books;
  document.getElementById('s-total').textContent = allBooks.length;
  document.getElementById('s-read').textContent = readBooks.length;
  const rated = readBooks.filter(b => b.rating && b.rating > 0);
  document.getElementById('s-avg-rating').textContent = rated.length 
    ? (rated.reduce((s,b) => s + b.rating, 0) / rated.length).toFixed(1) + '★'
    : '—';
  const genres = new Set(readBooks.map(b => b.genre).filter(Boolean));
  document.getElementById('s-genres').textContent = genres.size;

  // ---- Year chart ----
  const yearCounts = {};
  const curYear = new Date().getFullYear();
  for (let y = curYear - 4; y <= curYear; y++) yearCounts[y] = 0;
  readBooks.forEach(b => {
    if (b.dateRead) {
      const y = parseInt(b.dateRead.substring(0, 4));
      if (yearCounts[y] !== undefined) yearCounts[y]++;
    }
  });
  const maxYear = Math.max(...Object.values(yearCounts), 1);
  document.getElementById('year-chart').innerHTML = Object.entries(yearCounts).map(([y, c]) => `
    <div class="year-bar-wrap">
      <div class="year-bar" data-val="${c}" style="height:${Math.max(4, (c/maxYear)*100)}%; background:${y == curYear ? 'var(--accent)' : 'var(--border)'}; margin-top:auto;" title="${c} books in ${y}"></div>
      <div class="year-bar-label">${y}</div>
    </div>
  `).join('');

  // ---- Monthly chart (current year) ----
  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const monthlyCounts = new Array(12).fill(0);
  readBooks.forEach(b => {
    if (b.dateRead && b.dateRead.startsWith(curYear.toString())) {
      const m = parseInt(b.dateRead.substring(5, 7)) - 1;
      if (m >= 0 && m < 12) monthlyCounts[m]++;
    }
  });
  const maxMonth = Math.max(...monthlyCounts, 1);
  document.getElementById('monthly-chart').innerHTML = monthlyCounts.map((c, i) => `
    <div class="year-bar-wrap">
      <div class="year-bar" data-val="${c}" style="height:${Math.max(4, (c/maxMonth)*100)}%; background:${i === new Date().getMonth() ? 'var(--accent)' : 'var(--blue)'}; opacity:${c===0?'0.3':'1'}; margin-top:auto;" title="${c} books in ${monthNames[i]}"></div>
      <div class="year-bar-label">${monthNames[i].substring(0,1)}</div>
    </div>
  `).join('');

  // ---- Genre chart ----
  const genreCount = {};
  readBooks.forEach(b => { if (b.genre) genreCount[b.genre] = (genreCount[b.genre]||0) + 1; });
  const topGenres = Object.entries(genreCount).sort((a,b) => b[1]-a[1]).slice(0,6);
  const maxGenre = topGenres[0]?.[1] || 1;
  const genreColors = ['var(--accent)','var(--green)','var(--blue)','var(--purple)','var(--red)','var(--star)'];
  document.getElementById('genre-chart').innerHTML = topGenres.length 
    ? topGenres.map(([g, c], i) => `
        <div class="bar-row">
          <div class="bar-label">${escHtml(g.substring(0,12))}</div>
          <div class="bar-track"><div class="bar-fill" style="width:${(c/maxGenre)*100}%;background:${genreColors[i%genreColors.length]};"></div></div>
          <div class="bar-value">${c}</div>
        </div>
      `).join('')
    : '<div style="color:var(--text-muted);font-size:13px;">Add genres to see stats</div>';

  // ---- Top Authors (most read) ----
  const authorCount = {};
  readBooks.forEach(b => { if (b.author) authorCount[b.author] = (authorCount[b.author]||0) + 1; });
  const topAuthors = Object.entries(authorCount).sort((a,b) => b[1]-a[1]).slice(0,5);
  const rankLabels = ['gold','silver','bronze','',''];
  document.getElementById('authors-list').innerHTML = topAuthors.length 
    ? topAuthors.map(([a, c], i) => `
        <div class="top-item">
          <div class="top-rank ${rankLabels[i]}">${i+1}</div>
          <div class="top-info"><div class="top-name">${escHtml(a)}</div><div class="top-sub">Author</div></div>
          <div class="top-val">${c} book${c!==1?'s':''}</div>
        </div>
      `).join('')
    : '<div style="color:var(--text-muted);font-size:13px;">No books marked as read yet</div>';

  // ---- Rating distribution ----
  const ratingDist = [0,0,0,0,0];
  rated.forEach(b => { if (b.rating >= 1 && b.rating <= 5) ratingDist[b.rating-1]++; });
  const maxRating = Math.max(...ratingDist, 1);
  document.getElementById('rating-chart').innerHTML = [5,4,3,2,1].map(r => `
    <div class="bar-row">
      <div class="bar-label">${'★'.repeat(r)}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(ratingDist[r-1]/maxRating)*100}%;background:var(--star);"></div></div>
      <div class="bar-value">${ratingDist[r-1]}</div>
    </div>
  `).join('');

  // ---- Best Rated Books Leaderboard ----
  const ratedBooks = readBooks.filter(b => b.rating > 0).sort((a,b) => {
    if (b.rating !== a.rating) return b.rating - a.rating;
    return (b.dateRead || '').localeCompare(a.dateRead || '');
  }).slice(0, 10);
  const medalClass = (i) => i === 0 ? 'lb-medal-1' : i === 1 ? 'lb-medal-2' : i === 2 ? 'lb-medal-3' : 'lb-medal-n';
  const medalChar = (i) => i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : `${i+1}`;
  document.getElementById('best-rated-list').innerHTML = ratedBooks.length
    ? ratedBooks.map((book, i) => `
        <div class="leaderboard-item" onclick="openBookDetail('${book.id}')" style="cursor:pointer;">
          <div class="leaderboard-rank ${medalClass(i)}">${medalChar(i)}</div>
          <div class="leaderboard-cover">${bookCoverImg(book)}</div>
          <div class="leaderboard-info">
            <div class="leaderboard-title">${escHtml(book.title)}</div>
            <div class="leaderboard-sub">${escHtml(book.author)}${book.dateRead ? ' · ' + book.dateRead.substring(0,4) : ''}</div>
          </div>
          <div class="leaderboard-score">${'★'.repeat(book.rating)}</div>
        </div>
      `).join('')
    : '<div style="color:var(--text-muted);font-size:13px;padding:10px 0;">Rate some books to see your leaderboard</div>';

  // ---- Most Read Authors (with cover sample) ----
  const authorData = {};
  readBooks.forEach(b => {
    if (!b.author) return;
    if (!authorData[b.author]) authorData[b.author] = { count: 0, books: [], totalRating: 0, ratedCount: 0 };
    authorData[b.author].count++;
    authorData[b.author].books.push(b);
    if (b.rating) { authorData[b.author].totalRating += b.rating; authorData[b.author].ratedCount++; }
  });
  const topAuthorsFull = Object.entries(authorData).sort((a,b) => b[1].count - a[1].count).slice(0, 8);
  document.getElementById('most-read-authors-list').innerHTML = topAuthorsFull.length
    ? topAuthorsFull.map(([author, data], i) => {
        const avgRating = data.ratedCount ? (data.totalRating / data.ratedCount).toFixed(1) : null;
        const sampleBook = data.books.find(b => b.coverUrl) || data.books[0];
        return `
          <div class="leaderboard-item">
            <div class="leaderboard-rank ${medalClass(i)}">${medalChar(i)}</div>
            <div class="leaderboard-cover">${sampleBook ? bookCoverImg(sampleBook) : ''}</div>
            <div class="leaderboard-info">
              <div class="leaderboard-title">${escHtml(author)}</div>
              <div class="leaderboard-sub">${data.count} book${data.count!==1?'s':''}${avgRating ? ` · avg ${avgRating}★` : ''}</div>
            </div>
            <div class="leaderboard-score" style="color:var(--accent);">${data.count}</div>
          </div>
        `;
      }).join('')
    : '<div style="color:var(--text-muted);font-size:13px;padding:10px 0;">No read books yet</div>';

  // ---- Reading Summary ----
  const totalPages = readBooks.reduce((s, b) => s + (b.pages || 0), 0);
  const thisYearBooks = readBooks.filter(b => b.dateRead && b.dateRead.startsWith(curYear.toString()));
  const booksWithDates = readBooks.filter(b => b.dateStarted && b.dateRead);
  let avgDays = 0;
  if (booksWithDates.length) {
    const totalDays = booksWithDates.reduce((s, b) => {
      const diff = (new Date(b.dateRead) - new Date(b.dateStarted)) / 86400000;
      return s + (diff > 0 ? diff : 0);
    }, 0);
    avgDays = Math.round(totalDays / booksWithDates.length);
  }
  document.getElementById('reading-summary').innerHTML = `
    <div class="time-stat-box">
      <div class="time-stat-val">${thisYearBooks.length}</div>
      <div class="time-stat-label">Books this year</div>
    </div>
    <div class="time-stat-box">
      <div class="time-stat-val">${totalPages > 1000 ? (totalPages/1000).toFixed(1)+'k' : totalPages}</div>
      <div class="time-stat-label">Pages read total</div>
    </div>
    <div class="time-stat-box">
      <div class="time-stat-val">${avgDays || '—'}</div>
      <div class="time-stat-label">Avg days per book</div>
    </div>
  `;

  // ---- Format Breakdown ----
  const owned = books.filter(b => b.ownPhysical || b.ownDigital || b.ownBorrowed);
  const physCount = books.filter(b => b.ownPhysical).length;
  const digCount = books.filter(b => b.ownDigital).length;
  const borCount = books.filter(b => b.ownBorrowed).length;
  const maxFmt = Math.max(physCount, digCount, borCount, 1);
  document.getElementById('format-chart').innerHTML = [
    ['📖 Physical', physCount, 'var(--green)'],
    ['💻 Digital', digCount, 'var(--blue)'],
    ['🤝 Borrowed', borCount, 'var(--purple)'],
  ].map(([label, count, color]) => `
    <div class="bar-row">
      <div class="bar-label" style="font-size:11px;">${label}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${(count/maxFmt)*100}%;background:${color};"></div></div>
      <div class="bar-value">${count}</div>
    </div>
  `).join('') + (physCount + digCount + borCount === 0 ? '<div style="color:var(--text-muted);font-size:13px;">Track ownership when adding books</div>' : '');
}

// ---- SETTINGS ----
function showSettingsPanel(id, el) {
  document.querySelectorAll('.settings-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.settings-nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('sp-' + id).classList.add('active');
  el.classList.add('active');
  // Load profile data when switching to profile panel
  if (id === 'profile') {
    const nameEl = document.getElementById('profile-display-name');
    const emailEl = document.getElementById('profile-email');
    if (nameEl) nameEl.value = settings.displayName || currentUser?.displayName || '';
    if (emailEl) emailEl.textContent = currentUser?.email || '—';
  }
}

async function saveDisplayName() {
  const name = document.getElementById('profile-display-name').value.trim();
  if (!name) { showToast('Please enter a display name', 'error'); return; }
  settings.displayName = name;
  save();
  // Update greeting and sidebar
  updateUserUI(currentUser);
  showToast(`Display name updated to "${name}"`, 'success');
}

async function saveGoal() {
  const val = parseInt(document.getElementById('goal-input').value);
  if (!val || val < 1) { showToast('Enter a valid goal (1+)', 'error'); return; }
  settings.goal = val;
  settings.goalYear = new Date().getFullYear();
  save();
  showToast(`Goal set: ${val} books in ${settings.goalYear}`, 'success');
  refreshDashboard();
}

// ---- IMPORT / EXPORT ----
function importGoodreads(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async e => {
    try {
      const text = e.target.result;
      const rows = parseCSV(text);
      if (!rows.length) { showToast('No books found in CSV', 'error'); return; }
      let added = 0;
      const batch = [];
      rows.forEach(row => {
        const title = row['Title'] || row['title'];
        const author = row['Author'] || row['author'] || row['Author l-f'];
        if (!title) return;
        const statusMap = { 'read': 'read', 'currently-reading': 'reading', 'to-read': 'want' };
        const grShelf = (row['Exclusive Shelf'] || row['Bookshelves'] || 'to-read').toLowerCase();
        const status = statusMap[grShelf] || 'want';
        const rating = parseInt(row['My Rating'] || row['rating']) || 0;
        if (!books.find(b => b.title.toLowerCase() === title.toLowerCase())) {
          const book = {
            id: genId(),
            title: title.trim(),
            author: (author || 'Unknown').replace(/,\s*(\w+)\s*$/, ' $1').trim(),
            genre: row['Bookshelves'] || '',
            status, rating,
            dateRead: row['Date Read'] || '',
            pages: parseInt(row['Number of Pages'] || row['pages']) || 0,
            notes: row['My Review'] || '',
            dateAdded: Date.now(),
            collections: [],
          };
          batch.push(book);
          added++;
        }
      });
      // Save each book to Firestore
      showToast(`Importing ${added} books...`, 'info');
      for (const book of batch) {
        await saveBookToFirestore(book);
      }
      showToast(`Imported ${added} books from Goodreads ✓`, 'success');
    } catch(err) {
      console.error(err);
      showToast('Failed to parse Goodreads CSV', 'error');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function importShelfwise(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async e => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.books) {
        showToast(`Importing ${data.books.length} books...`, 'info');
        for (const book of data.books) {
          await saveBookToFirestore(book);
        }
      }
      if (data.collections) {
        for (const col of data.collections) {
          await saveCollectionToFirestore(col);
        }
      }
      if (data.settings) {
        settings = { ...settings, ...data.settings };
        await saveSettingsToFirestore();
        applyTheme();
      }
      showToast('Library restored from backup ✓', 'success');
    } catch(err) {
      showToast('Invalid ConnieReads JSON file', 'error');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function exportData(format) {
  if (format === 'json') {
    const data = { books, collections, settings, exportedAt: new Date().toISOString(), version: '1.0' };
    downloadFile(JSON.stringify(data, null, 2), 'conniereads-backup.json', 'application/json');
    showToast('Library exported as JSON', 'success');
  } else if (format === 'csv') {
    const headers = ['Title','Author','Genre','Status','Rating','Date Read','Pages','Notes','Own Physical','Own Digital','Borrowed'];
    const rows = books.map(b => [
      b.title, b.author, b.genre || '', b.status, b.rating || '', b.dateRead || '', b.pages || '',
      (b.notes || '').replace(/"/g,'""'), b.ownPhysical ? 'Yes' : '', b.ownDigital ? 'Yes' : '', b.ownBorrowed ? 'Yes' : ''
    ].map(v => `"${v}"`).join(','));
    downloadFile([headers.join(','), ...rows].join('\n'), 'conniereads-library.csv', 'text/csv');
    showToast('Library exported as CSV', 'success');
  }
}

async function clearAllData() {
  if (!confirm('This will permanently delete ALL your books, collections, and settings from the cloud. This CANNOT be undone. Type DELETE to confirm.')) return;
  const conf = prompt('Type DELETE to confirm:');
  if (conf !== 'DELETE') return;
  showToast('Clearing all data...', 'info');
  // Delete all books
  for (const book of [...books]) {
    await deleteBookFromFirestore(book.id);
  }
  // Delete all collections
  for (const col of [...collections]) {
    try { await fb().deleteDoc(fb().doc(collectionsCol(), col.id)); } catch(e) {}
  }
  settings = { theme: settings.theme, goal: 0, goalYear: new Date().getFullYear() };
  await saveSettingsToFirestore();
  renderLibrary();
  renderCollections();
  refreshDashboard();
  showToast('All data cleared', 'info');
}

// ---- TOAST ----
function showToast(message, type = 'info') {
  const cont = document.getElementById('toast-container');
  const icons = { success: '✅', error: '❌', info: 'ℹ️' };
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `<span class="toast-icon">${icons[type]}</span><span>${message}</span>`;
  cont.appendChild(toast);
  setTimeout(() => { toast.classList.add('toast-fade-out'); setTimeout(() => toast.remove(), 300); }, 3500);
}

// ---- HELPERS ----
function genId() { return Math.random().toString(36).substr(2,9) + Date.now().toString(36); }
function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function statusLabel(s) { return { want:'Want to Read', reading:'Reading', read:'Read', dnf:'DNF', borrowed:'Borrowed' }[s] || s; }
function timeAgo(ts) {
  const s = Math.floor((Date.now() - ts) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s/60) + 'm ago';
  if (s < 86400) return Math.floor(s/3600) + 'h ago';
  return Math.floor(s/86400) + 'd ago';
}
function downloadFile(content, filename, mime) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content], { type: mime }));
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}
function parseCSV(text) {
  const lines = text.split('\n');
  if (!lines.length) return [];
  const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g,''));
  return lines.slice(1).filter(l => l.trim()).map(line => {
    const vals = [];
    let cur = '', inQ = false;
    for (const ch of line) {
      if (ch === '"') inQ = !inQ;
      else if (ch === ',' && !inQ) { vals.push(cur); cur = ''; }
      else cur += ch;
    }
    vals.push(cur);
    return Object.fromEntries(headers.map((h, i) => [h, (vals[i]||'').trim().replace(/^"|"$/g,'')]));
  });
}

// ---- INIT ----
document.addEventListener('DOMContentLoaded', () => {
  loadLocal();
  applyTheme();
  const year = new Date().getFullYear();
  document.getElementById('goal-year').textContent = year;
  document.getElementById('goal-year-setting').textContent = year;
  if (settings.goal) document.getElementById('goal-input').value = settings.goal;
  const themeToggle = document.getElementById('theme-toggle-settings');
  if (themeToggle) themeToggle.classList.toggle('on', settings.theme === 'dark');
  refreshDashboard();
});
</script>

</body>
</html>